<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير تفعيل التعلم الإلكتروني</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Embedding Cairo Font via @import for better reliability */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        
        /* Custom styles for A4 size and printing */
        @page {
            size: A4;
            margin: 0;
        }

        body {
            /* Set Cairo as the primary font with robust fallbacks */
            font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f0f0f0; 
            padding: 10px; 
            display: flex; 
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh; 
        }

        .a4-page {
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            margin: 0 auto; 
            background-image: url('https://d.top4top.io/p_3567auk9h1.jpg');
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            padding: 1.5cm 1.5cm 1.0cm 1.5cm; 
            color: #000000; 
            font-size: 12px; 
            display: flex; 
            flex-direction: column; 
            
        }
        
        /* Content Wrapper to push the footer/signature down if content is short */
        .content-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            gap: 0.1rem; /* Very tight spacing between sections */
        }

        /* Input fields inside tables */
        .fillable-input {
            background-color: rgba(255, 255, 255, 0.7); 
            border: none; 
            color: #000000; 
            padding: 0 4px;
            outline: none;
            width: 100%;
            opacity: 1; 
            font-size: 11px; /* Slightly reduced font size for tables */
        }
        
        /* Placeholder styling removed as per request, but kept for general inputs */
        .fillable-input::placeholder {
            color: #333333; 
            opacity: 0.7; 
            font-size: 10px; 
        }

        /* Input fields that are readonly/fixed content */
        .fixed-input {
            background-color: rgba(240, 240, 240, 0.7); /* Slightly darker background to show they are fixed */
            color: #000000; 
            font-weight: 500;
            cursor: default;
        }

        /* Header inputs (No background, No border, White text) */
        .header-input {
            background-color: transparent !important;
            border: none; 
            color: #ffffff !important; 
            text-align: right;
            font-weight: 800; 
            font-size: 16px; 
        }
        .header-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* White text for main title */
        .h1-title {
            color: #ffffff !important;
            font-size: 20px; 
            margin-bottom: 0; 
        }

        /* Black text for section titles (with light background for legibility) */
        .h2-title {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 8px; 
            border-radius: 4px;
            color: #000000;
            display: inline-block;
            margin-bottom: 0.05rem; 
            margin-top: 0.15rem; 
            font-size: 12px; 
        }

        /* Styling for the tables */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.1rem; 
            color: #000000; 
            font-size: 9px; 
        }

        .report-table th, .report-table td {
            border: 1px solid #666666; 
            padding: 2px; 
            text-align: center;
            background-color: rgba(255, 255, 255, 0.8); 
        }

        .report-table th {
            background-color: #b2ebdd; 
        }

        /* Signature label (Muedd/Mudir/Mushrif) must be black and smaller */
        .signature-label-text {
            color: #000000; 
            font-size: 10px; 
            margin-bottom: 1px; 
            font-weight: bold;
        }

        /* Signature Input Styling: Name input below the label (Line 1: Name) */
        .signature-input-name {
            text-align: center;
            width: 100%;
            color: #000000; 
            font-size: 12px;
            border: none; 
            background-color: transparent;
            outline: none;
            padding-bottom: 0;
            margin-top: 4px; 
        }
         /* Signature Input Styling: Job title input (Line 2: Title) */
        .signature-input-title {
            text-align: center;
            width: 100%;
            color: #000000; 
            font-size: 10px; /* Smaller font for the title */
            border: none; 
            background-color: transparent;
            outline: none;
            padding-top: 0;
            margin-bottom: 2px;
        }
        
        /* Signature Footer Container - Tighter vertical margin */
        .signature-footer {
            width: 100%;
            margin-top: 0; /* Minimal margin */
            padding-top: 2px; 
            padding-bottom: 2px; 
            flex-shrink: 0; 
        }

        /* Evidence Box Styling (Container for 4 image slots) */
        .evidence-box {
            background-color: transparent; 
            border: none; 
            padding: 5px; 
            text-align: right;
            min-height: 130px; /* Reduced height for tighter spacing */
            flex-shrink: 0; 
        }

        /* Image Slot Container - Ensures flexibility and correct aspect ratio */
        .image-slot-container {
            width: 24.2%;
            position: relative;
        }
        .image-slot-aspect {
            width: 100%;
            padding-top: 100%; 
            position: relative;
            
            transition: all 0.2s;
            cursor: pointer;
            border: 1px dashed #666; 
            background-color: rgba(255, 255, 255, 0.5); 
            border-radius: 8px; 
            overflow: hidden;
        }
        .image-slot-aspect:hover {
            opacity: 0.9;
            background-color: rgba(240, 240, 240, 0.8);
        }

        /* Content inside the image slot */
        .image-slot-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 8px;
        }
        
        /* Print media query to remove shadows and ensure full-page print */
        @media print {
            body {
                padding: 0;
                background-color: #ffffff; 
                justify-content: flex-start;
                align-items: flex-start;
            }
            .a4-page {
                margin: 0;
                box-shadow: none;
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
            }
            /* Hide print button */
            .print-button {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- Print Button for convenience -->
    <div class="fixed top-4 left-4 z-50 print-button">
        <button onclick="window.print()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-150">
            طباعة الصفحة (A4)
        </button>
    </div>

    <div class="a4-page">
        <!-- Header Section -->
        
        <!-- الإدارة والمدرسة - Positioned to the top edge -->
        <header class="absolute top-[20px] right-[70mm] flex flex-col items-end space-y-1"> 
            <!-- اسم الادارة التعليمية -->
            <input type="text" id="adminName" data-key="adminName" class="header-input text-right w-full" placeholder="الإدارة التعليمية (سجل هنا اسم الإدارة كاملاً)">
            <!-- اسم المدرسة -->
            <input type="text" id="schoolName" data-key="schoolName" class="header-input text-right w-[100mm]" placeholder="المدرسة (سجل هنا اسم المدرسة كاملاً)">
        </header>
        

        <!-- Report Title - mt-8 for a slightly raised position -->
        <h1 class="h1-title text-right mb-3 py-1 mr-[55mm] mt-6">تفعيل المدرسة للتعلم الالكتروني</h1>

        <!-- Content Wrapper to contain all tables and evidence -->
        <div class="content-wrapper">
            <!-- Table 1: Date and Place -->
            <div class="mb-0"> 
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>الفصل الدراسي</th>
                            <th>اليوم</th>
                            <th>التاريخ</th>
                            <th>مكان التفعيل</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" data-key="t1_col1" class="fillable-input text-center" placeholder="الفصل"></td>
                            <td><input type="text" data-key="t1_col2" class="fillable-input text-center" placeholder="اليوم"></td>
                            <td><input type="text" data-key="t1_col3" class="fillable-input text-center" placeholder="التاريخ"></td>
                            <td><input type="text" data-key="t1_col4" class="fillable-input text-center" placeholder="المكان"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 2: Personnel (5 rows) -->
            <div class="mb-0"> 
                <h2 class="h2-title">الكادر المفعل للتعليم الإلكتروني</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">م</th>
                            <th>اسم الكادر المفعل للتعليم الالكتروني</th>
                            <th>عمله داخل المدرسة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 5 rows for personnel -->
                        <tr><td>1</td><td><input type="text" data-key="t2_r1c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r1c2" class="fillable-input" placeholder="العمل"></td></tr>
                        <tr><td>2</td><td><input type="text" data-key="t2_r2c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r2c2" class="fillable-input" placeholder="العمل"></td></tr>
                        <tr><td>3</td><td><input type="text" data-key="t2_r3c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r3c2" class="fillable-input" placeholder="العمل"></td></tr>
                        <tr><td>4</td><td><input type="text" data-key="t2_r4c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r4c2" class="fillable-input" placeholder="العمل"></td></tr>
                        <tr><td>5</td><td><input type="text" data-key="t2_r5c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r5c2" class="fillable-input" placeholder="العمل"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 3: E-Learning Platform Type (Updated fixed labels) -->
            <div class="mb-0"> 
                <h2 class="h2-title">نوع التفعيل الالكتروني المستخدم</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">م</th>
                            <th>اسم المنصة</th>
                            <th>ملاحظات أو تفاصيل</th> 
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Fixed Platforms (Readonly) -->
                        <tr><td>1</td><td><input type="text" data-key="t3_r1c1" class="fillable-input fixed-input" value="اسم المنصة" readonly></td><td><input type="text" data-key="t3_r1c2" class="fillable-input"></td></tr>
                        <tr><td>2</td><td><input type="text" data-key="t3_r2c1" class="fillable-input fixed-input" value="اسم القناة" readonly></td><td><input type="text" data-key="t3_r2c2" class="fillable-input"></td></tr>
                        <tr><td>3</td><td><input type="text" data-key="t3_r3c1" class="fillable-input fixed-input" value="اسم البرنامج" readonly></td><td><input type="text" data-key="t3_r3c2" class="fillable-input"></td></tr>
                        <!-- Other Type (Now fixed in first column) -->
                        <tr><td>4</td><td><input type="text" data-key="t3_r4c1" class="fillable-input fixed-input" value="أخرى: تذكر" readonly></td><td><input type="text" data-key="t3_r4c2" class="fillable-input"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 4: Devices Used -->
            <div class="mb-0"> 
                <h2 class="h2-title">اسم الجهاز الالكتروني المستخدم</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">م</th>
                            <th>اسم الجهاز</th>
                            <th class="w-20">مربع اختيار</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>جهاز عرض (بروجكتر)</td><td><input type="checkbox" data-key="t4_c1" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                        <tr><td>2</td><td>جهاز كمبيوتر مكتبي</td><td><input type="checkbox" data-key="t4_c2" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                        <tr><td>3</td><td>جهاز لابتوب</td><td><input type="checkbox" data-key="t4_c3" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                        <tr><td>4</td><td>جهاز الايباد</td><td><input type="checkbox" data-key="t4_c4" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                        <tr><td>5</td><td>جهاز الجوال</td><td><input type="checkbox" data-key="t4_c5" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                        <tr><td>6</td><td>أخرى: <input type="text" data-key="t4_c6_text" class="fillable-input w-40 text-xs" placeholder="اسم الجهاز الآخر"></td><td><input type="checkbox" data-key="t4_c6" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 5: Target Audience -->
            <div class="mb-0"> 
                <h2 class="h2-title">الفئة المستهدفة</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="text" data-key="t5_r1c1" class="fillable-input" placeholder="الفئة المستهدفة"></td>
                            <td>2</td>
                            <td><input type="text" data-key="t5_r1c2" class="fillable-input" placeholder="الفئة المستهدفة"></td>
                            <td>3</td>
                            <td><input type="text" data-key="t5_r1c3" class="fillable-input" placeholder="الفئة المستهدفة"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 6: Objectives and Impact -->
            <div class="mb-0"> 
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-1/2">الهدف من استخدام التفعيل الالكتروني (1 - 4 أهداف)</th>
                            <th class="w-1/2">الأثر الإيجابي التربوي والتعليمي للتفعيل الالكتروني المذكور</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><input type="text" data-key="t6_r1c1" class="fillable-input" placeholder="الهدف 1"></td><td><input type="text" data-key="t6_r1c2" class="fillable-input" placeholder="الأثر 1"></td></tr>
                        <tr><td><input type="text" data-key="t6_r2c1" class="fillable-input" placeholder="الهدف 2"></td><td><input type="text" data-key="t6_r2c2" class="fillable-input" placeholder="الأثر 2"></td></tr>
                        <tr><td><input type="text" data-key="t6_r3c1" class="fillable-input" placeholder="الهدف 3"></td><td><input type="text" data-key="t6_r3c2" class="fillable-input" placeholder="الأثر 3"></td></tr>
                        <tr><td><input type="text" data-key="t6_r4c1" class="fillable-input" placeholder="الهدف 4"></td><td><input type="text" data-key="t6_r4c2" class="fillable-input" placeholder="الأثر 4"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Evidence Section (Image Uploads) - mb-0 for minimal space before signature -->
            <div class="mb-0"> 
                <h2 class="h2-title">شواهد التفعيل</h2>
                
                <div class="evidence-box flex justify-between gap-2 p-2 items-center">
                    
                    <!-- Image Slot 1 -->
                    <div class="image-slot-container">
                        <div id="imageSlot1" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput1" data-slot="1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview1" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label1" class="p-1 text-black z-0">صورة 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Slot 2 -->
                    <div class="image-slot-container">
                        <div id="imageSlot2" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput2" data-slot="2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview2" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label2" class="p-1 text-black z-0">صورة 2</span>
                            </div>
                        </div>
                    </div>

                    <!-- Image Slot 3 -->
                    <div class="image-slot-container">
                        <div id="imageSlot3" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput3" data-slot="3" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview3" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label3" class="p-1 text-black z-0">صورة 3</span>
                            </div>
                        </div>
                    </div>

                    <!-- Image Slot 4 -->
                    <div class="image-slot-container">
                        <div id="imageSlot4" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput4" data-slot="4" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview4" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label4" class="p-1 text-black z-0">صورة 4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End of content-wrapper -->
        
        <!-- Signature/Name Boxes - Tightly spaced to fit on page -->
        <div class="signature-footer flex justify-between px-4">
            
            <!-- أمينة مصادر التعلم -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">أمينة مصادر التعلم</p>
                <!-- Name (Bolded) -->
                <input type="text" data-key="signature_1_name" class="signature-input-name font-bold">
                <!-- Title (الصفة) -->
                <input type="text" data-key="signature_1_title" class="signature-input-title">
            </div>
            
            <!-- مشرفة الدعم -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">مشرفة الدعم</p>
                <!-- Name (Bolded) -->
                <input type="text" data-key="signature_2_name" class="signature-input-name font-bold">
                <!-- Title (الصفة) -->
                <input type="text" data-key="signature_2_title" class="signature-input-title">
            </div>
            
            <!-- مديرة المدرسة -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">مديرة المدرسة</p>
                <!-- Name (Bolded) -->
                <input type="text" data-key="signature_3_name" class="signature-input-name font-bold">
                <!-- Title (الصفة) -->
                <input type="text" data-key="signature_3_title" class="signature-input-title">
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const IMAGE_SLOTS = 4; // Number of image slots
        const REPORT_DOC_ID = 'content'; // Fixed document ID for the report data

        // --- DOM Elements ---
        const allPersistentInputs = Array.from(document.querySelectorAll('input[data-key]:not([type="file"])'));

        let db, auth;
        let userId;
        
        /**
         * Converts a File object to a Base64 string.
         * WARNING: Files resulting in a Base64 string > 1MB will fail to save to Firestore.
         * @param {File} file 
         * @returns {Promise<string>} Base64 string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Displays a custom alert/modal message to the user.
         * @param {string} message The message to display.
         */
        function showCustomAlert(message) {
            const containerId = 'customAlertContainer';
            let container = document.getElementById(containerId);
            
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                // Basic fixed centering style for the modal container
                container.style.cssText = `
                    position:fixed;
                    top:0;
                    left:0;
                    width:100%;
                    height:100%;
                    background:rgba(0,0,0,0.5);
                    z-index:9999;
                    display:flex;
                    justify-content:center;
                    align-items:center;
                `;
                document.body.appendChild(container);
            }
            
            // Modal content structure
            container.innerHTML = `
                <div style="
                    background:white;
                    padding:20px;
                    border-radius:10px;
                    box-shadow:0 0 15px rgba(0,0,0,0.7);
                    max-width: 90%;
                    text-align: center;
                    font-family: 'Cairo', sans-serif;
                ">
                    <p style="margin-bottom: 15px; color: #333; font-size: 14px;">${message}</p>
                    <button onclick="document.getElementById('${containerId}').remove()" 
                        style="
                            padding:8px 15px;
                            background:#f44336;
                            color:white;
                            border:none;
                            border-radius:5px;
                            cursor:pointer;
                            font-weight: bold;
                        ">إغلاق</button>
                </div>
            `;
            container.style.display = 'flex'; // Ensure it's visible
        }


        /**
         * Handles image file selection, conversion to Base64, and display.
         * @param {HTMLInputElement} input The file input element
         */
        window.handleImageUpload = async function(input) {
            const slotNumber = input.getAttribute('data-slot');
            const file = input.files[0];
            const previewElement = document.getElementById(`preview${slotNumber}`);
            const labelElement = document.getElementById(`label${slotNumber}`);
            const imageKey = `imageSlot${slotNumber}`;
            
            if (file) {
                try {
                    const base64String = await fileToBase64(file);
                    
                    // Update DOM
                    previewElement.src = base64String;
                    previewElement.classList.remove('hidden');
                    previewElement.classList.add('z-10'); 
                    labelElement.classList.add('hidden');
                    
                    // Save the Base64 string immediately
                    await saveData({ [imageKey]: base64String }, true); // Force save image data
                    
                } catch (error) {
                    // Log the error for development purposes
                    console.error("Error reading file:", error.message); 
                    
                    // Clear the slot appearance and the input
                    previewElement.src = ''; // Clear image source
                    previewElement.classList.add('hidden');
                    previewElement.classList.remove('z-10'); 
                    labelElement.classList.remove('hidden');
                    // Reset the file input so the user can re-select the same file if they resize it externally
                    input.value = ''; 
                    
                    // Clear the slot in persistence (although usually not needed if it was never saved)
                    await saveData({ [imageKey]: '' }, true);
                }
            } else {
                 // If file is cleared
                previewElement.classList.add('hidden');
                previewElement.classList.remove('z-10');
                labelElement.classList.remove('hidden');
                await saveData({ [imageKey]: '' }, true); // Clear the slot in persistence
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`User authenticated with ID: ${userId}`);
                
                // Start loading data and listening for changes
                setupPersistence();

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        }

        /**
         * Saves persistent data to Firestore privately.
         * @param {Object} [partialData] Optional partial data to merge (used for immediate image save)
         * @param {boolean} [isImageSave=false] Flag to indicate if this is only an image save (to prevent saving text fields prematurely)
         */
        async function saveData(partialData = {}, isImageSave = false) {
            if (!db || !userId) {
                console.warn("Firestore or User ID not ready for saving.");
                return;
            }

            const data = {};
            
            // Only collect text/checkbox data if it's not exclusively an image save
            if (!isImageSave) {
                allPersistentInputs.forEach(input => {
                    const key = input.getAttribute('data-key');
                    if (input.type === 'checkbox') {
                        data[key] = input.checked;
                    } else if (!input.hasAttribute('readonly')) { // Only save value if not readonly
                        data[key] = input.value;
                    }
                    // For the special fixed inputs in table 3, we don't save the value as they are fixed text.
                });
            }

            // Manually handle fixed inputs in Table 3 if needed for persistence, 
            // but since they are `readonly` and have fixed `value`s, they don't need to be saved
            // as they are regenerated on load.

            Object.assign(data, partialData, { updatedAt: new Date().toISOString() });

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/report_data`, REPORT_DOC_ID);
            
            try {
                await setDoc(docRef, data, { merge: true });
            } catch (error) {
                console.error("Error saving data:", error);
                
                // --- Specific error handling for 1MB size limit ---
                if (error.code === 'invalid-argument' && error.message.includes('longer than 1048487 bytes')) {
                    // Find which image slot caused the error (only relevant if it's an image save)
                    const failedImageKey = Object.keys(partialData).find(key => key.startsWith('imageSlot'));
                    
                    if (failedImageKey) {
                        const slotNumber = failedImageKey.replace('imageSlot', '');
                        const previewElement = document.getElementById(`preview${slotNumber}`);
                        const labelElement = document.getElementById(`label${slotNumber}`);
                        const fileInputElement = document.getElementById(`fileInput${slotNumber}`);

                        // 1. Clear the image display
                        previewElement.src = '';
                        previewElement.classList.add('hidden');
                        previewElement.classList.remove('z-10');
                        labelElement.classList.remove('hidden');

                        // 2. Clear the file input (optional but helps prevent re-attempting the save)
                        fileInputElement.value = '';

                        // 3. Show alert to user
                        showCustomAlert("خطأ في حفظ الصورة: تجاوز حجم الملف الحد الأقصى المسموح به في قاعدة البيانات (1 ميجابايت). الرجاء استخدام صورة أصغر أو ضغطها.");
                    } else {
                        // Fallback for general invalid-argument error
                        showCustomAlert("حدث خطأ في حفظ البيانات. قد يكون بسبب تجاوز حجم حقل بيانات آخر.");
                    }
                } else {
                    // Handle other Firebase errors (e.g., permission denied, network issues)
                    showCustomAlert("حدث خطأ غير متوقع أثناء حفظ البيانات.");
                }
            }
        }

        /**
         * Loads and subscribes to data changes from Firestore.
         */
        function setupPersistence() {
            if (!db || !userId) return;

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/report_data`, REPORT_DOC_ID);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update all persistent inputs (Header, Table, Signature)
                    allPersistentInputs.forEach(input => {
                        const key = input.getAttribute('data-key');
                        const value = data[key];
                        if (value !== undefined) {
                            if (input.type === 'checkbox') {
                                input.checked = value;
                            } else if (!input.hasAttribute('readonly')) { // Only update value if not readonly
                                input.value = value;
                            }
                        }
                    });

                    // Update Image Slots
                    for(let i = 1; i <= IMAGE_SLOTS; i++) {
                        const imageKey = `imageSlot${i}`;
                        const base64 = data[imageKey] || '';
                        const previewElement = document.getElementById(`preview${i}`);
                        const labelElement = document.getElementById(`label${i}`);

                        if (base64 && base64.startsWith('data:')) {
                            previewElement.src = base64;
                            previewElement.classList.remove('hidden');
                            previewElement.classList.add('z-10'); // Ensure image is visible over the label
                            labelElement.classList.add('hidden');
                        } else {
                            previewElement.src = '';
                            previewElement.classList.add('hidden');
                            previewElement.classList.remove('z-10');
                            labelElement.classList.remove('hidden');
                        }
                    }

                } else {
                    console.log("No data found, starting fresh.");
                }
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }

        // --- Event Listeners for Auto-Save (Debounced for performance) ---
        let saveTimeout;
        const DEBOUNCE_DELAY = 1000; // 1 second delay

        function debounceSave() {
            clearTimeout(saveTimeout);
            // Call saveData without partialData and set isImageSave=false to save all non-image fields
            saveTimeout = setTimeout(() => saveData(), DEBOUNCE_DELAY);
        }

        // Attach listeners to all persistent inputs
        allPersistentInputs.forEach(input => {
            // Only attach listener if the input is meant to be editable (i.e., not readonly)
            if (!input.hasAttribute('readonly')) {
                input.addEventListener('input', debounceSave);
            }
        });

        // Initialize everything on window load
        initializeFirebase();

    </script>
</body>
</html>
