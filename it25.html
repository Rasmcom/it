<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>تقرير تفعيل التعلم الإلكتروني</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* خط كايرو */
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

  /* ألوان وأبعاد قابلة للتعديل */
  :root{
    --navy:#0c2f4b;      /* كحلي غامق */
    --green:#16a34a;     /* أخضر */
    --blue:#0ea5e9;      /* أزرق */
    --top-strip-h:3mm;   /* شريط علوي صغير */
    --header-h:32mm;     /* ارتفاع الهيدر (صغّرناه) */
    --footer-h:5mm;      /* ارتفاع الفوتر (صغّرناه) */
    --sig-h:18mm;        /* ارتفاع التواقيع (صغّرناه) */
  }

  html,body{ height:auto; }
  body{
    font-family:'Cairo',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:#f0f0f0; margin:0; padding:10px;
    display:flex; justify-content:center; color:#000;
  }

  .a4-page{
    width:210mm; min-height:297mm; background:#fff; position:relative; margin:0 auto;
    box-shadow:0 0 10px rgba(0,0,0,.25); overflow:hidden;
  }

  /* الهيدر/الفوتر بالألوان (للشاشة) عبر ::before/::after */
  .a4-page::before{
    content:""; position:absolute; top:0; left:0; right:0; height:var(--header-h);
    background:
      linear-gradient(90deg, var(--green) 0 50%, var(--blue) 50% 100%) top/100% var(--top-strip-h) no-repeat,
      var(--navy);
    z-index:0;
  }
  .a4-page::after{
    content:""; position:absolute; bottom:0; left:0; right:0; height:var(--footer-h);
    background: linear-gradient(90deg, var(--green) 0 50%, var(--blue) 50% 100%);
    z-index:0;
  }

  /* حقول الهيدر فوق الخلفية */
  .header-fields{
    position:absolute; top:0; left:0; right:0; height:var(--header-h);
    display:flex; flex-direction:column; align-items:flex-end; justify-content:flex-start;
    padding: 5mm 15mm; z-index:2;
  }
  .header-input{
    background:transparent; border:none; outline:none; width:100%;
    text-align:right; color:#fff; font-weight:900; font-size:14px; padding:2px 4px;
  }
  .header-title{
    color:#fff; font-weight:900; font-size:16px; text-align:center; line-height:1.2;
    text-shadow:1px 1px 2px rgba(0,0,0,.5); margin-top:2mm; width:100%;
  }

  /* المحتوى والتواقيع */
  .content-wrapper{
    position:relative; z-index:1;
    margin: calc(var(--header-h) + 1mm) 0 0 0;  /* بدون هوامش جانبية */
    padding:0;
  }
  .signature-footer{
    position:absolute; left:0; right:0; bottom: calc(var(--footer-h) + 1mm);
    height: var(--sig-h); margin:0; padding:0; z-index:1;
    display:flex; justify-content:space-between;
  }
  .signature-label-text{ font-size:10px; font-weight:700; margin-bottom:2px; }
  .signature-input-name{
    width:100%; text-align:center; font-weight:900; border:none; background:transparent; outline:none;
  }

  /* الحقول الأساسية */
  .main-data-input{
    background:rgba(245,245,245,.9);
    border:1px solid #ccc; color:#000; text-align:center;
    font-weight:900; font-size:14px; padding:4px 8px; border-radius:6px;
  }
  label{ font-weight:900 !important; font-size:13px !important; color:#000 !important; }

  /* الجداول */
  .h2-title{
    background:#e0f7fa; padding:2px 8px; border-radius:4px; color:#000;
    display:inline-block; margin:.15rem 0 .05rem; font-size:14px; font-weight:700;
    border-right:4px solid #00bcd4;
  }
  .report-table{ width:100%; border-collapse:collapse; margin-top:.05rem; color:#000; font-size:10px; }
  .report-table th,.report-table td{ border:1px solid #666; padding:2px; text-align:center; background:#fff; }
  .report-table th{ background:#b2ebdd; font-size:11px; }
  .fillable-input{ background:#fff; border:1px dashed #666; color:#000; padding:0 4px; width:100%; font-size:11px; font-weight:bold; outline:none; }
  .platform-input{ border:1px solid #666 !important; border-radius:0 !important; }

  /* الشواهد (صور) */
  .evidence-box{ border:1px dashed #bbb; border-radius:6px; padding:4px; }
  .image-slot-container{ width:24.2%; position:relative; }
  .image-slot-aspect{ width:100%; padding-top:60%; position:relative; border:1px dashed #666; background:rgba(240,240,240,.5); border-radius:6px; overflow:hidden; }
  .image-slot-content{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-size:8px; }
  .image-slot-content img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:none; }

  /* زر طباعة */
  .print-button{ position:fixed; top:1rem; left:1rem; z-index:50; }

  /* ===== الطباعة: بدون هوامش + صفحة واحدة A4 ===== */
  @page{ size:A4 portrait; margin:0; }
  @media print{
    :root{ --print-scale: 0.96; } /* غيّرها 0.95 إذا لزم */

    html,body{ margin:0 !important; padding:0 !important; background:#fff !important; }
    .print-button{ display:none !important; }

    .a4-page{
      width:210mm !important; height:297mm !important; min-height:297mm !important;
      margin:0 !important; box-shadow:none !important; overflow:hidden !important;
      -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important;
      transform: scale(var(--print-scale)); transform-origin: top center;
    }
    /* الخلفيات الملونة ثابتة */
    .a4-page::before{ position:fixed; }
    .a4-page::after{ position:fixed; }

    /* أقصى ارتفاع للمحتوى داخل الصفحة (بدون هوامش جانبية) */
    .content-wrapper{
      margin: calc(var(--header-h) + 1mm) 0 0 0 !important;
      max-height: calc(297mm - var(--header-h) - var(--footer-h) - var(--sig-h) - 2mm) !important;
      overflow:hidden !important; padding:0 !important;
    }

    /* التواقيع مثبتة أعلى الفوتر ولا تدفش المحتوى */
    .signature-footer{
      position:absolute; left:0; right:0; bottom: calc(var(--footer-h) + 1mm);
      height: var(--sig-h); margin:0 !important; padding:0 !important;
    }

    /* تقليل الحشو لربح ارتفاع */
    .report-table th, .report-table td{ padding:0.6mm !important; line-height:1.15 !important; }

    /* الصور أثناء الطباعة */
    .image-slot-content input[type="file"]{ display:none !important; }
    .image-slot-content img{ display:block !important; }

    /* نصوص قوية */
    .header-input{ color:#fff !important; font-weight:900 !important; font-size:14px !important; }
    label{ font-weight:900 !important; color:#000 !important; }
    .main-data-input{
      border:1px solid #999 !important; background:#f5f5f5 !important; border-radius:4px !important;
      font-weight:900 !important; color:#000 !important;
    }

    @supports (-webkit-touch-callout:none){
      .a4-page{ transform: scale(var(--print-scale)); transform-origin: top center; }
    }
  }
  /* ===== Ultra Tight One-Page Print (iOS + Chrome) ===== */
@page { size: A4 portrait; margin: 0; }

/* أبعاد مضغوطة */
:root{
  --top-strip-h: 2mm;   /* شريط علوي صغير */
  --header-h:   28mm;   /* الهيدر الكحلي */
  --footer-h:    4mm;   /* الفوتر */
  --sig-h:      16mm;   /* منطقة التواقيع */
}

@media print{
  /* لو لسه صفحتين: قلّل إلى 0.93 */
  :root{ --print-scale: 0.94; }

  /* ألغِ أي تلاعب بالألوان في الطباعة وثبّت الخلفيات */
  *, *::before, *::after{
    -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
  }

  html, body{
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
  }

  /* صفحة A4 بلا هوامش خارجية */
  .a4-page{
    width:210mm !important; height:297mm !important; min-height:297mm !important;
    margin:0 !important; box-shadow:none !important; overflow:hidden !important;
    transform: scale(var(--print-scale)); transform-origin: top center;
    position: relative;
  }

  /* الهيدر/الفوتر الخلفيات الملونة تبقى ثابتة */
  .a4-page::before{
    content:""; position:fixed; top:0; left:0; right:0; height:var(--header-h);
    background:
      linear-gradient(90deg, var(--green) 0 50%, var(--blue) 50% 100%) top/100% var(--top-strip-h) no-repeat,
      var(--navy);
    z-index:0 !important;
  }
  .a4-page::after{
    content:""; position:fixed; bottom:0; left:0; right:0; height:var(--footer-h);
    background: linear-gradient(90deg, var(--green) 0 50%, var(--blue) 50% 100%);
    z-index:0 !important;
  }

  /* المحتوى بلا هوامش جانبية وبحد أقصى للارتفاع */
  .content-wrapper{
    margin: calc(var(--header-h) + 0.5mm) 0 0 0 !important;   /* أعلى فقط */
    max-height: calc(297mm - var(--header-h) - var(--footer-h) - var(--sig-h) - 1mm) !important;
    overflow: hidden !important;
    padding: 0 !important;
  }

  /* التواقيع مثبتة فوق الفوتر مباشرة ولا تدفش المحتوى */
  .signature-footer{
    position: absolute; left: 0; right: 0;
    bottom: calc(var(--footer-h) + 0.5mm);
    height: var(--sig-h);
    margin: 0 !important; padding: 0 !important;
    z-index: 1;
  }

  /* تصغير الخطوط قليلاً */
  .header-input{ font-size: 13px !important; font-weight: 900 !important; color:#fff !important; }
  label{ font-size: 12px !important; font-weight: 900 !important; }
  .main-data-input{
    font-size: 13px !important; font-weight: 900 !important;
    padding: 2px 6px !important; border-radius: 4px !important;
    border: 1px solid #999 !important; background: #f5f5f5 !important; color:#000 !important;
  }
  .h2-title{
    font-size: 13px !important;
    margin: 0 0 1mm 0 !important;      /* يقلّل الفراغ تحت العنوان */
    padding: 1px 6px !important;
  }

  /* جداول أضيق */
  .report-table{ font-size: 9px !important; }
  .report-table th{ font-size: 10px !important; }
  .report-table th, .report-table td{
    padding: 0.5mm !important;
    line-height: 1.1 !important;
    background: #fff !important;
  }

  /* إزالة الفراغ بين عنوان "شواهد التفعيل" والصور + تصغير مربعات الصور */
  .evidence-box{
    margin-top: 1mm !important;
    padding: 2px !important;            /* كان 4px */
    border-width: 1px !important;
  }
  .image-slot-aspect{ padding-top: 52% !important; } /* كان 60–70% */
  .image-slot-content{ font-size: 7px !important; }
  .image-slot-content input[type="file"]{ display: none !important; }
  .image-slot-content img{
    display: block !important; position: absolute !important; inset: 0 !important;
    width: 100% !important; height: 100% !important; object-fit: cover !important;
  }

  /* أخفِ عناصر العرض فقط */
  .print-button, .fixed-header-container, .fixed-footer-container{ display:none !important; }

  /* دعم iOS/Android */
  @supports (-webkit-touch-callout:none){
    .a4-page{ transform: scale(var(--print-scale)); transform-origin: top center; }
  }
}
</style>
</head>
<body>
  <!-- زر طباعة -->
  <div class="print-button">
    <button onclick="window.print()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-150">
      طباعة الصفحة (A4)
    </button>
  </div>

  <div class="a4-page">
    <!-- حقول الهيدر -->
    <div class="header-fields">
      <input type="text" data-key="adminName" class="header-input w-2/3 mb-1 text-right" placeholder="اسم الإدارة التعليمية" />
      <input type="text" data-key="schoolName" class="header-input w-2/3 text-right" placeholder="اسم المدرسة" />
      <p class="header-title text-center">تفعيل المدرسة للتعلم الإلكتروني</p>
    </div>

    <!-- المحتوى -->
    <div class="content-wrapper">
      <!-- البلوك الأساسي -->
      <div class="grid grid-cols-4 gap-2 p-1 bg-gray-50 border border-gray-200 rounded-lg text-xs">
        <div><label class="block text-xs text-gray-700 mb-1">الفصل الدراسي</label>
          <input type="text" data-key="t1_col1" class="main-data-input w-full text-center" placeholder="مثال: الأول / الثاني">
        </div>
        <div><label class="block text-xs text-gray-700 mb-1">اليوم</label>
          <input type="text" data-key="t1_col2" class="main-data-input w-full text-center" placeholder="مثال: الأحد">
        </div>
        <div><label class="block text-xs text-gray-700 mb-1">التاريخ</label>
          <input type="text" data-key="t1_col3" class="main-data-input w-full text-center" placeholder="مثال: 2025-01-01">
        </div>
        <div><label class="block text-xs text-gray-700 mb-1">المكان</label>
          <input type="text" data-key="t1_col4" class="main-data-input w-full text-center" placeholder="مثال: مركز مصادر التعلم">
        </div>
      </div>

      <!-- جدول 1 -->
      <div class="mb-0 mt-1">
        <h2 class="h2-title">الكادر المفعل للتعليم الإلكتروني</h2>
        <table class="report-table">
          <thead><tr><th class="w-8">م</th><th class="w-1/2">اسم الكادر المفعل للتعليم الالكتروني</th><th class="w-1/2">عمله داخل المدرسة</th></tr></thead>
          <tbody>
            <tr><td>1</td><td><input type="text" data-key="t2_r1c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r1c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>2</td><td><input type="text" data-key="t2_r2c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r2c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>3</td><td><input type="text" data-key="t2_r3c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r3c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>4</td><td><input type="text" data-key="t2_r4c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r4c2" class="fillable-input" placeholder="العمل"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 2 -->
      <div class="mb-0">
        <h2 class="h2-title">نوع التفعيل الإلكتروني المستخدم واسم الجهاز</h2>
        <table class="report-table">
          <thead><tr><th class="w-1/2">نوع التفعيل الإلكتروني المستخدم (المنصة/القناة/البرنامج)</th><th class="w-1/2">اسم الجهاز الإلكتروني المستخدم (اختر الأجهزة)</th></tr></thead>
          <tbody>
            <tr>
              <td class="p-0 align-top">
                <table class="report-table border-0 w-full">
                  <tr class="border-0"><td class="border w-1/3 font-bold text-xs text-right">اسم المنصة:</td><td class="border w-2/3 p-0"><input type="text" data-key="t3_r1c2" class="fillable-input platform-input text-right" placeholder="مثال: منصة مدرستي"></td></tr>
                  <tr class="border-0"><td class="border w-1/3 font-bold text-xs text-right">اسم القناة/المصدر:</td><td class="border w-2/3 p-0"><input type="text" data-key="t3_r2c2" class="fillable-input platform-input text-right" placeholder="مثال: قناة عين"></td></tr>
                  <tr class="border-0"><td class="border w-1/3 font-bold text-xs text-right">اسم البرنامج:</td><td class="border w-2/3 p-0"><input type="text" data-key="t3_r3c2" class="fillable-input platform-input text-right" placeholder="مثال: Teams / Zoom"></td></tr>
                  <tr class="border-0"><td class="border w-1/3 font-bold text-xs text-right">أخرى:</td><td class="border w-2/3 p-0"><input type="text" data-key="t3_r4c2" class="fillable-input platform-input text-right" placeholder="حدد نوع التفعيل الآخر"></td></tr>
                </table>
              </td>
              <td class="p-0">
                <table class="report-table border-0 w-full">
                  <tbody>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز عرض (بروجكتر)</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c1" class="h-4 w-4"></td>
                      <td class="border-0 w-1/4 text-right">جهاز كمبيوتر مكتبي</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c2" class="h-4 w-4"></td>
                    </tr>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز لابتوب</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c3" class="h-4 w-4"></td>
                      <td class="border-0 w-1/4 text-right">جهاز الايباد</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c4" class="h-4 w-4"></td>
                    </tr>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز الجوال</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c5" class="h-4 w-4"></td>
                      <td class="border-0 w-1/4 text-right">أخرى: <input type="text" data-key="t4_c6_text" class="fillable-input w-20 text-xs text-right" placeholder="جهاز آخر"></td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c6" class="h-4 w-4"></td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 3 -->
      <div class="mb-0">
        <h2 class="h2-title">الفئة المستهدفة</h2>
        <table class="report-table">
          <thead><tr><th class="w-1/6">رقم</th><th class="w-1/3">تحديد الفئة</th><th class="w-1/6">رقم</th><th class="w-1/3">تحديد الفئة</th></tr></thead>
          <tbody>
            <tr><td>1</td><td><input type="text" data-key="t5_r1c1" class="fillable-input" placeholder="الفئة المستهدفة"></td><td>2</td><td><input type="text" data-key="t5_r1c2" class="fillable-input" placeholder="الفئة المستهدفة"></td></tr>
            <tr><td>3</td><td><input type="text" data-key="t5_r1c3" class="fillable-input" placeholder="الفئة المستهدفة"></td><td>4</td><td><input type="text" data-key="t5_r1c4" class="fillable-input" placeholder="الفئة المستهدفة"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 4: الأهداف والأثر (3 فقط) -->
      <div class="mb-0">
        <h2 class="h2-title">الأهداف والأثر التربوي</h2>
        <table class="report-table">
          <thead>
            <tr>
              <th class="w-1/2">الهدف من استخدام التفعيل الإلكتروني (حتى 3 أهداف)</th>
              <th class="w-1/2">الأثر الإيجابي التربوي والتعليمي للتفعيل الإلكتروني المذكور (حتى 3 آثار)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><input type="text" data-key="t6_r1c1" class="fillable-input" placeholder="الهدف 1"></td><td><input type="text" data-key="t6_r1c2" class="fillable-input" placeholder="الأثر 1"></td></tr>
            <tr><td><input type="text" data-key="t6_r2c1" class="fillable-input" placeholder="الهدف 2"></td><td><input type="text" data-key="t6_r2c2" class="fillable-input" placeholder="الأثر 2"></td></tr>
            <tr><td><input type="text" data-key="t6_r3c1" class="fillable-input" placeholder="الهدف 3"></td><td><input type="text" data-key="t6_r3c2" class="fillable-input" placeholder="الأثر 3"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- الشواهد (صور) -->
      <div class="mb-0">
        <h2 class="h2-title">شواهد التفعيل (صور)</h2>
        <div class="evidence-box flex justify-between gap-2 items-center">
          <div class="image-slot-container">
            <div id="imageSlot1" class="image-slot-aspect">
              <div class="image-slot-content">
                <input type="file" id="fileInput1" data-slot="1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview1" class="hidden z-10">
                <span id="label1" class="p-1 text-black z-0 font-bold">صورة 1 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot2" class="image-slot-aspect">
              <div class="image-slot-content">
                <input type="file" id="fileInput2" data-slot="2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview2" class="hidden z-10">
                <span id="label2" class="p-1 text-black z-0 font-bold">صورة 2 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot3" class="image-slot-aspect">
              <div class="image-slot-content">
                <input type="file" id="fileInput3" data-slot="3" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview3" class="hidden z-10">
                <span id="label3" class="p-1 text-black z-0 font-bold">صورة 3 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot4" class="image-slot-aspect">
              <div class="image-slot-content">
                <input type="file" id="fileInput4" data-slot="4" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview4" class="hidden z-10">
                <span id="label4" class="p-1 text-black z-0 font-bold">صورة 4 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /content-wrapper -->

    <!-- التواقيع -->
    <div class="signature-footer px-4">
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">أمينة مصادر التعلم</p>
        <input type="text" data-key="signature_1_name" class="signature-input-name" placeholder="الاسم">
      </div>
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">مشرفة الدعم</p>
        <input type="text" data-key="signature_2_name" class="signature-input-name" placeholder="الاسم">
      </div>
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">مديرة المدرسة</p>
        <input type="text" data-key="signature_3_name" class="signature-input-name" placeholder="الاسم">
      </div>
    </div>
  </div><!-- /a4-page -->

  <!-- حفظ محلي بسيط -->
  <script>
    const STORE='eLearningReportData';
    const inputs=[...document.querySelectorAll('input[data-key]:not([type="file"])')];
    function save(partial={}){
      let data={};
      try{ const s=localStorage.getItem(STORE); if(s) data=JSON.parse(s);}catch(e){}
      inputs.forEach(i=>{ data[i.dataset.key]= i.type==='checkbox'? i.checked : i.value; });
      Object.assign(data, partial);
      try{ localStorage.setItem(STORE, JSON.stringify(data)); }catch(e){}
    }
    function load(){
      try{
        const s=localStorage.getItem(STORE); if(!s) return; const data=JSON.parse(s);
        inputs.forEach(i=>{ const v=data[i.dataset.key]; if(v!==undefined){ if(i.type==='checkbox'){i.checked=v;} else {i.value=v;} }});
        for(let k=1;k<=4;k++){
          const base64=data['imageSlot'+k]||'';
          const img=document.getElementById('preview'+k), lab=document.getElementById('label'+k);
          if(base64 && base64.startsWith('data:')){ img.src=base64; img.classList.remove('hidden'); lab.classList.add('hidden'); }
        }
      }catch(e){}
    }
    let t; function deb(){ clearTimeout(t); t=setTimeout(save, 400); }
    inputs.forEach(i=> i.addEventListener('input', deb));

    async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; if(file.size>800*1024){rej(new Error('حجم الصورة أكبر من 800KB')); return;} r.readAsDataURL(file); }); }
    window.handleImageUpload=async (el)=>{
      const n=el.dataset.slot, file=el.files[0], img=document.getElementById('preview'+n), lab=document.getElementById('label'+n);
      if(!file){ img.classList.add('hidden'); lab.classList.remove('hidden'); save({['imageSlot'+n]:''}); return; }
      try{ const b64=await fileToBase64(file); img.src=b64; img.classList.remove('hidden'); lab.classList.add('hidden'); save({['imageSlot'+n]:b64}); }
      catch(e){ alert('خطأ في تحميل الصورة: '+e.message); el.value=''; img.classList.add('hidden'); lab.classList.remove('hidden'); save({['imageSlot'+n]:''}); }
    }
    window.onload=load;
  </script>
</body>
</html>
