<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقرير تفعيل التعلم الإلكتروني</title>
  <!-- Tailwind (للعرض فقط؛ الطباعة تعتمد على CSS أدناه) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* خط كايرو */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

    /* قفل مقياس الصفحة للطباعة */
    @page { size: A4 portrait; margin: 0; }

    /* أساسيات العرض */
    body {
      font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background-color: #f0f0f0;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 10vh;
      color: #000;
    }

    .a4-page {
      width: 210mm;
      min-height: 297mm;
      background: #fff;
      margin: 0 auto;
      position: relative;
      padding: 1.5cm 1.5cm 1.0cm 1.5cm;
      box-shadow: 0 0 10px rgba(0,0,0,.3);
      display: flex;
      flex-direction: column;
    }

    /* هيدر وفوتر للعرض (الشاشة) */
    .fixed-header-container {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 35mm;
      background-image: url('https://l.top4top.io/p_3571r7e6d1.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center top;
      z-index: 10;
      display: flex; flex-direction: column; justify-content: space-between; align-items: center;
      padding: 5mm 15mm;
    }
    .header-title {
      color: #fff; font-weight: 900; font-size: 16px; text-align: center; line-height: 1.2;
      text-shadow: 1px 1px 2px rgba(0,0,0,.5); margin: 2mm 0 0;
      width: 100%;
    }
    .fixed-footer-container {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 15mm;
      background-image: url('https://c.top4top.io/p_35710bpos1.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center bottom;
      z-index: 10;
    }

    /* إدخالات شاشة الهيدر */
    .header-input {
      background: transparent;
      border: none;
      color: #fff;
      text-align: right;
      font-weight: 900;  /* بولد قوي للشاشة */
      font-size: 14px;
      padding: 2px 4px;
      outline: none;
      width: 100%;
    }

    /* منطقة المحتوى */
    .content-wrapper { flex-grow: 1; display: flex; flex-direction: column; gap: .1rem; z-index: 20; }

    /* الحقول الأساسية (الفصل/اليوم/التاريخ/المكان) */
    .main-data-input {
      background-color: rgba(245,245,245,0.9);
      border: 1px solid #ccc;
      color: #000;
      text-align: center;
      font-weight: 900;  /* بولد أقوى من bold */
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    /* العناوين الثابتة فوق الحقول (labels) — تكبير + بولد */
    label {
      font-weight: 900 !important;
      font-size: 13px !important;
      color: #000 !important;
    }

    .h2-title {
      background-color: #e0f7fa; padding: 2px 8px; border-radius: 4px;
      color: #000; display: inline-block; margin: .15rem 0 .05rem;
      font-size: 14px; font-weight: bold; border-right: 4px solid #00bcd4;
    }

    /* الجداول */
    .report-table { width: 100%; border-collapse: collapse; margin-top: .05rem; color: #000; font-size: 10px; }
    .report-table th, .report-table td { border: 1px solid #666; padding: 2px; text-align: center; background-color: rgba(255,255,255,0.9); }
    .report-table th { background-color: #b2ebdd; font-size: 11px; }

    .fillable-input {
      background-color: rgba(255,255,255,0.8);
      border: 1px dashed #666;
      color: #000;
      padding: 0 4px;
      outline: none;
      width: 100%;
      opacity: 1;
      font-size: 11px;
      font-weight: bold;
    }

    .platform-input { border: 1px solid #666 !important; border-radius: 0 !important; }

    /* الشواهد (الصور) */
    .evidence-box { background: transparent; border: none; padding: 2px; text-align: right; min-height: 110px; flex-shrink: 0; }
    .image-slot-container { width: 24.2%; position: relative; }
    .image-slot-aspect { width: 100%; padding-top: 70%; position: relative; transition: all .2s; cursor: pointer; border: 1px dashed #666; background-color: rgba(240,240,240,.5); border-radius: 6px; overflow: hidden; }
    .image-slot-aspect:hover { opacity: .9; background-color: rgba(220,220,220,.8); }
    .image-slot-content { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 8px; }
    .image-slot-content img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; }

    /* التواقيع */
    .signature-label-text { color: #000; font-size: 10px; margin-bottom: 1px; font-weight: bold; }
    .signature-input-name {
      text-align: center; width: 100%; color: #000; font-size: 12px; border: none; background: transparent; outline: none; padding-bottom: 0; margin-top: 4px; font-weight: 900;
    }
    .signature-input-title {
      text-align: center; width: 100%; color: #000; font-size: 10px; border: none; background: transparent; outline: none; padding-top: 0; margin-bottom: 2px; height: 18px;
    }
    .signature-footer { width: 100%; margin-top: 1rem; padding: 2px 0; flex-shrink: 0; }

    /* زر الطباعة */
    .print-button { position: fixed; top: 1rem; left: 1rem; z-index: 50; }

    /* ====== وضع الطباعة ====== */
    @media print {
      /* تحكم سريع بحجم الإخراج لو المحتوى طويل (عدّل القيمة حسب الحاجة) */
      :root { --print-scale: 1.00; } /* جرّب 0.96 إلى 1.00 */

      html, body { height: auto !important; background: #fff !important; }
      .print-button, .fixed-header-container, .fixed-footer-container { display: none !important; }

      .a4-page {
        width: 210mm !important;
        height: 297mm !important;
        min-height: 297mm !important;
        margin: 0 !important;
        padding-top: 38mm !important;   /* مساحة الهيدر */
        padding-bottom: 15mm !important;/* مساحة الفوتر */
        overflow: hidden !important;     /* منع الصفحة الثانية */
        box-shadow: none !important;
        -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
        transform: scale(var(--print-scale));
        transform-origin: top center;
        position: relative;
      }

      /* الهيدر والفوتر كخلفية ثابتة باستخدام before/after (أكثر ثباتًا على الجوال) */
      .a4-page::before,
      .a4-page::after {
        content: "";
        position: fixed;
        left: 0; right: 0;
        background-repeat: no-repeat;
        background-size: cover;
        z-index: 0 !important; /* خلف المحتوى */
        -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
      }
      .a4-page::before {
        top: 0;
        height: 35mm;
        background-image: url('https://l.top4top.io/p_3571r7e6d1.png'); /* الهيدر */
        background-position: center top;
      }
      .a4-page::after {
        bottom: 0;
        height: 15mm;
        background-image: url('https://c.top4top.io/p_35710bpos1.png'); /* الفوتر */
        background-position: center bottom;
      }

      /* منطقة المحتوى: قصّ أي زيادة */
      .content-wrapper {
        margin-top: 0 !important;
        max-height: calc(297mm - 38mm - 15mm - 8mm) !important; /* 8mm احتياط داخلي */
        overflow: hidden !important;
        position: relative;
        z-index: 1; /* فوق الخلفية */
        padding: 0 !important;
      }

      /* مظهر الحقول الأساسية في الطباعة */
      .main-data-input {
        border: 1px solid #999 !important;
        background-color: #f5f5f5 !important;
        border-radius: 4px !important;
        font-weight: 900 !important; /* فقط بولد (بدون تكبير) */
        color: #000 !important;
      }

      /* العناوين الثابتة بولد */
      label { font-weight: 900 !important; color: #000 !important; }

      /* تبديل مدخلات الهيدر للون الأبيض وبولد */
      .header-input { color: #fff !important; font-weight: 900 !important; }

      /* تحسين ثبات الصور داخل الشواهد أثناء الطباعة */
      .image-slot-content input[type="file"] { display: none !important; }
      .image-slot-content img {
        display: block !important;
        position: absolute !important;
        inset: 0 !important;
        width: 100% !important; height: 100% !important;
        object-fit: cover !important;
      }

      /* إزالة خلفيات خلايا الجدول التي قد تتسبب بتقطيع */
      .report-table td { background-color: transparent !important; }

      /* دعم iOS Safari و Android Chrome */
      @supports (-webkit-touch-callout: none) {
        .a4-page { transform: scale(var(--print-scale)); transform-origin: top center; }
      }
    }
  </style>
</head>

<body>
  <!-- زر طباعة سريع -->
  <div class="print-button">
    <button onclick="window.print()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-150">
      طباعة الصفحة (A4)
    </button>
  </div>

  <div class="a4-page">
    <!-- هيدر العرض -->
    <div class="fixed-header-container">
      <div class="header-group w-full flex flex-col items-end justify-start h-full px-4">
        <input type="text" id="adminName_screen" data-key="adminName" class="header-input w-2/3 mb-1 text-right" placeholder="اسم الإدارة التعليمية" />
        <input type="text" id="schoolName_screen" data-key="schoolName" class="header-input w-2/3 text-right" placeholder="اسم المدرسة" />
        <br />
        <p class="header-title text-center">تفعيل المدرسة للتعلم الإلكتروني</p>
      </div>
    </div>

    <!-- فوتر العرض -->
    <div class="fixed-footer-container"></div>

    <!-- المحتوى -->
    <div class="content-wrapper mt-[25mm] mb-[8mm] p-0">
      <!-- البلوك الأساسي -->
      <div class="grid grid-cols-4 gap-2 p-1 bg-gray-50 border border-gray-200 rounded-lg text-xs">
        <div>
          <label class="block text-xs text-gray-700 mb-1">الفصل الدراسي</label>
          <input type="text" data-key="t1_col1" class="main-data-input w-full text-center" placeholder="مثال: الأول / الثاني">
        </div>
        <div>
          <label class="block text-xs text-gray-700 mb-1">اليوم</label>
          <input type="text" data-key="t1_col2" class="main-data-input w-full text-center" placeholder="مثال: الأحد">
        </div>
        <div>
          <label class="block text-xs text-gray-700 mb-1">التاريخ</label>
          <input type="text" data-key="t1_col3" class="main-data-input w-full text-center" placeholder="مثال: 01-01-2025">
        </div>
        <div>
          <label class="block text-xs text-gray-700 mb-1">المكان</label>
          <input type="text" data-key="t1_col4" class="main-data-input w-full text-center" placeholder="مثال: مركز مصادر التعلم">
        </div>
      </div>

      <!-- جدول 1: الكادر -->
      <div class="mb-0 mt-1">
        <h2 class="h2-title">الكادر المفعل للتعليم الإلكتروني</h2>
        <table class="report-table">
          <thead>
            <tr>
              <th class="w-8">م</th>
              <th class="w-1/2">اسم الكادر المفعل للتعليم الالكتروني</th>
              <th class="w-1/2">عمله داخل المدرسة</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1</td><td><input type="text" data-key="t2_r1c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r1c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>2</td><td><input type="text" data-key="t2_r2c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r2c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>3</td><td><input type="text" data-key="t2_r3c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r3c2" class="fillable-input" placeholder="العمل"></td></tr>
            <tr><td>4</td><td><input type="text" data-key="t2_r4c1" class="fillable-input" placeholder="الاسم"></td><td><input type="text" data-key="t2_r4c2" class="fillable-input" placeholder="العمل"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 2: المنصة والأجهزة -->
      <div class="mb-0">
        <h2 class="h2-title">نوع التفعيل الإلكتروني المستخدم واسم الجهاز</h2>
        <table class="report-table">
          <thead>
            <tr>
              <th class="w-1/2">نوع التفعيل الإلكتروني المستخدم (المنصة/القناة/البرنامج)</th>
              <th class="w-1/2">اسم الجهاز الإلكتروني المستخدم (اختر الأجهزة)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="p-0 align-top">
                <table class="report-table border-0 w-full">
                  <tr class="border-0">
                    <td class="border w-1/3 font-bold text-xs text-right">اسم المنصة:</td>
                    <td class="border w-2/3 p-0"><input type="text" data-key="t3_r1c2" class="fillable-input platform-input text-right" placeholder="مثال: منصة مدرستي"></td>
                  </tr>
                  <tr class="border-0">
                    <td class="border w-1/3 font-bold text-xs text-right">اسم القناة/المصدر:</td>
                    <td class="border w-2/3 p-0"><input type="text" data-key="t3_r2c2" class="fillable-input platform-input text-right" placeholder="مثال: قناة عين"></td>
                  </tr>
                  <tr class="border-0">
                    <td class="border w-1/3 font-bold text-xs text-right">اسم البرنامج:</td>
                    <td class="border w-2/3 p-0"><input type="text" data-key="t3_r3c2" class="fillable-input platform-input text-right" placeholder="مثال: Teams / Zoom"></td>
                  </tr>
                  <tr class="border-0">
                    <td class="border w-1/3 font-bold text-xs text-right">أخرى:</td>
                    <td class="border w-2/3 p-0"><input type="text" data-key="t3_r4c2" class="fillable-input platform-input text-right" placeholder="حدد نوع التفعيل الآخر"></td>
                  </tr>
                </table>
              </td>
              <td class="p-0">
                <table class="report-table border-0 w-full">
                  <tbody>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز عرض (بروجكتر)</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c1" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                      <td class="border-0 w-1/4 text-right">جهاز كمبيوتر مكتبي</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c2" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                    </tr>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز لابتوب</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c3" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                      <td class="border-0 w-1/4 text-right">جهاز الايباد</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c4" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                    </tr>
                    <tr class="border-0">
                      <td class="border-0 w-1/2 text-right">جهاز الجوال</td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c5" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                      <td class="border-0 w-1/4 text-right">
                        أخرى: <input type="text" data-key="t4_c6_text" class="fillable-input w-20 text-xs text-right" placeholder="جهاز آخر">
                      </td>
                      <td class="border-0 w-1/4"><input type="checkbox" data-key="t4_c6" class="h-4 w-4 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 3: الفئة المستهدفة -->
      <div class="mb-0">
        <h2 class="h2-title">الفئة المستهدفة</h2>
        <table class="report-table">
          <thead>
            <tr>
              <th class="w-1/6">رقم</th>
              <th class="w-1/3">تحديد الفئة</th>
              <th class="w-1/6">رقم</th>
              <th class="w-1/3">تحديد الفئة</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td><input type="text" data-key="t5_r1c1" class="fillable-input" placeholder="الفئة المستهدفة (مثال: طلاب الصف الثالث ثانوي)"></td>
              <td>2</td>
              <td><input type="text" data-key="t5_r1c2" class="fillable-input" placeholder="الفئة المستهدفة"></td>
            </tr>
            <tr>
              <td>3</td>
              <td><input type="text" data-key="t5_r1c3" class="fillable-input" placeholder="الفئة المستهدفة"></td>
              <td>4</td>
              <td><input type="text" data-key="t5_r1c4" class="fillable-input" placeholder="الفئة المستهدفة"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- جدول 4: الأهداف والأثر -->
      <div class="mb-0">
        <h2 class="h2-title">الأهداف والأثر التربوي</h2>
        <table class="report-table">
          <thead>
            <tr>
              <th class="w-1/2">الهدف من استخدام التفعيل الإلكتروني (1 - 4 أهداف)</th>
              <th class="w-1/2">الأثر الإيجابي التربوي والتعليمي للتفعيل الإلكتروني المذكور</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><input type="text" data-key="t6_r1c1" class="fillable-input" placeholder="الهدف 1"></td><td><input type="text" data-key="t6_r1c2" class="fillable-input" placeholder="الأثر 1"></td></tr>
            <tr><td><input type="text" data-key="t6_r2c1" class="fillable-input" placeholder="الهدف 2"></td><td><input type="text" data-key="t6_r2c2" class="fillable-input" placeholder="الأثر 2"></td></tr>
            <tr><td><input type="text" data-key="t6_r3c1" class="fillable-input" placeholder="الهدف 3"></td><td><input type="text" data-key="t6_r3c2" class="fillable-input" placeholder="الأثر 3"></td></tr>
            <tr><td><input type="text" data-key="t6_r4c1" class="fillable-input" placeholder="الهدف 4"></td><td><input type="text" data-key="t6_r4c2" class="fillable-input" placeholder="الأثر 4"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- الشواهد (صور) -->
      <div class="mb-0">
        <h2 class="h2-title">شواهد التفعيل (صور)</h2>
        <div class="evidence-box flex justify-between gap-2 p-1 items-center border border-dashed border-gray-400 rounded-lg">
          <div class="image-slot-container">
            <div id="imageSlot1" class="image-slot-aspect relative">
              <div class="image-slot-content">
                <input type="file" id="fileInput1" data-slot="1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview1" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                <span id="label1" class="p-1 text-black z-0 font-bold">صورة 1 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot2" class="image-slot-aspect relative">
              <div class="image-slot-content">
                <input type="file" id="fileInput2" data-slot="2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview2" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                <span id="label2" class="p-1 text-black z-0 font-bold">صورة 2 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot3" class="image-slot-aspect relative">
              <div class="image-slot-content">
                <input type="file" id="fileInput3" data-slot="3" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview3" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                <span id="label3" class="p-1 text-black z-0 font-bold">صورة 3 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
          <div class="image-slot-container">
            <div id="imageSlot4" class="image-slot-aspect relative">
              <div class="image-slot-content">
                <input type="file" id="fileInput4" data-slot="4" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                <img id="preview4" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                <span id="label4" class="p-1 text-black z-0 font-bold">صورة 4 (اضغط للتحميل)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /content-wrapper -->

    <!-- التواقيع -->
    <div class="signature-footer flex justify-between px-4 mt-2 mb-[15mm]">
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">أمينة مصادر التعلم</p>
        <input type="text" data-key="signature_1_name" class="signature-input-name" placeholder="الاسم">
      </div>
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">مشرفة الدعم</p>
        <input type="text" data-key="signature_2_name" class="signature-input-name" placeholder="الاسم">
      </div>
      <div class="text-center w-48 flex flex-col items-center">
        <p class="signature-label-text">مديرة المدرسة</p>
        <input type="text" data-key="signature_3_name" class="signature-input-name" placeholder="الاسم">
      </div>
    </div>
  </div><!-- /a4-page -->

  <!-- منطق الحفظ بالمتصفح -->
  <script>
    const DATA_KEY = 'eLearningReportData';
    const IMAGE_SLOTS = 4;

    const allPersistentInputs = Array.from(document.querySelectorAll('input[data-key]:not([type="file"]), textarea[data-key]'));
    const screenHeaderInputs = ['adminName', 'schoolName'];

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        if (file.size > 800 * 1024) { reject(new Error("File size exceeds 800 KB limit. Please use a smaller image.")); return; }
        reader.readAsDataURL(file);
      });
    }

    function showCustomAlert(message) {
      const containerId = 'customAlertContainer';
      let container = document.getElementById(containerId);
      if (!container) {
        container = document.createElement('div');
        container.id = containerId;
        container.style.cssText = `
          position:fixed; top:0; left:0; width:100%; height:100%;
          background:rgba(0,0,0,0.5); z-index:9999; display:flex;
          justify-content:center; align-items:center; font-family:'Cairo',sans-serif;
        `;
        document.body.appendChild(container);
      }
      container.innerHTML = `
        <div style="background:white; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.7); max-width:90%; text-align:center;">
          <p style="margin-bottom:15px; color:#333; font-size:14px; font-weight:bold;">${message}</p>
          <button onclick="document.getElementById('${containerId}').remove()"
            style="padding:8px 15px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">إغلاق</button>
        </div>
      `;
      container.style.display = 'flex';
    }

    window.handleImageUpload = async function(input) {
      const slotNumber = input.getAttribute('data-slot');
      const file = input.files[0];
      const previewElement = document.getElementById(`preview${slotNumber}`);
      const labelElement = document.getElementById(`label${slotNumber}`);
      const imageKey = `imageSlot${slotNumber}`;
      if (file) {
        try {
          const base64String = await fileToBase64(file);
          previewElement.src = base64String;
          previewElement.classList.remove('hidden'); previewElement.classList.add('z-10');
          labelElement.classList.add('hidden');
          saveData({ [imageKey]: base64String });
        } catch (error) {
          console.error("Error reading file:", error.message);
          previewElement.src = ''; previewElement.classList.add('hidden'); previewElement.classList.remove('z-10');
          labelElement.classList.remove('hidden');
          input.value = '';
          saveData({ [imageKey]: '' });
          showCustomAlert(`خطأ في تحميل الصورة: ${error.message}.`);
        }
      } else {
        previewElement.classList.add('hidden'); previewElement.classList.remove('z-10');
        labelElement.classList.remove('hidden');
        saveData({ [imageKey]: '' });
      }
    }

    function saveData(partialData = {}) {
      const data = {};
      try {
        const storedData = localStorage.getItem(DATA_KEY);
        if (storedData) Object.assign(data, JSON.parse(storedData));
      } catch (e) { console.error("Error retrieving data from localStorage:", e); }

      allPersistentInputs.forEach(input => {
        const key = input.getAttribute('data-key');
        if (input.type === 'checkbox') {
          data[key] = input.checked;
        } else {
          if (screenHeaderInputs.includes(key)) {
            data[key] = document.getElementById(`${key}_screen`).value;
          } else {
            data[key] = input.value;
          }
        }
      });

      Object.assign(data, partialData);

      try {
        localStorage.setItem(DATA_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("Error saving data to localStorage:", e);
        showCustomAlert("خطأ في حفظ البيانات: تجاوزت سعة التخزين المتاحة في المتصفح. الرجاء حذف بعض الصور أو تقليل حجمها.");
      }
    }

    function loadData() {
      try {
        const storedData = localStorage.getItem(DATA_KEY);
        if (!storedData) return;
        const data = JSON.parse(storedData);

        allPersistentInputs.forEach(input => {
          const key = input.getAttribute('data-key');
          const value = data[key];
          if (value !== undefined) {
            if (input.type === 'checkbox') {
              input.checked = value;
            } else {
              if (screenHeaderInputs.includes(key)) {
                document.getElementById(`${key}_screen`).value = value;
              } else {
                input.value = value;
              }
            }
          }
        });

        for (let i = 1; i <= 4; i++) {
          const imageKey = `imageSlot${i}`;
          const base64 = data[imageKey] || '';
          const previewElement = document.getElementById(`preview${i}`);
          const labelElement = document.getElementById(`label${i}`);
          if (base64 && base64.startsWith('data:')) {
            previewElement.src = base64;
            previewElement.classList.remove('hidden'); previewElement.classList.add('z-10');
            labelElement.classList.add('hidden');
          } else {
            previewElement.src = '';
            previewElement.classList.add('hidden'); previewElement.classList.remove('z-10');
            labelElement.classList.remove('hidden');
          }
        }
      } catch (error) { console.error("Error loading data from localStorage:", error); }
    }

    let saveTimeout;
    const DEBOUNCE_DELAY = 500;
    function debounceSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => saveData(), DEBOUNCE_DELAY); }

    allPersistentInputs.forEach(input => { input.addEventListener('input', debounceSave); });
    document.getElementById('adminName_screen').addEventListener('input', debounceSave);
    document.getElementById('schoolName_screen').addEventListener('input', debounceSave);

    window.onload = loadData;
  </script>
</body>
</html>
