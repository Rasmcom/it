<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير تفعيل التعلم الإلكتروني A4</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Embedding Cairo Font */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        
        /* تعريف الألوان المخصصة لـ Tailwind */
        :root {
            --dark-color: #003a47; /* اللون الغامق */
            --grad-start: #2896aa; /* بداية التدرج */
            --grad-end: #36ad7c; /* نهاية التدرج */
        }

        /*
        *****************************************************************
        قواعد الطباعة المخصصة لصفحة A4 (التصميم الجديد الصارم)
        *****************************************************************
        */
        @page {
            size: A4 portrait;
            /* تصفير الهامش لضمان أقصى مساحة ممكنة */
            margin: 0; 
        }

        @media print {
            /* إجبار المتصفح على طباعة الألوان والخلفيات بدقة */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* إخفاء زر الطباعة وأي عناصر تحكم */
            .no-print {
                display: none !important;
            }
            
            /* إخفاء الجدول الأول (التاريخ والمكان) كما طلب المستخدم لتوفير المساحة */
            .table-date-location {
                display: none !important;
            }

            /*
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            * تعديلات حاسمة لضغط المحتوى وضمان صفحة واحدة وإلغاء الهوامش الإلزامية للمتصفح (التاريخ/الوقت/الرابط) *
            * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            */
            
            /* منع ظهور رأس وتذييل الصفحة التلقائيين (يتحكم فيها المتصفح، لكن هذه محاولة لمنعها) */
            @page {
                margin: 0cm; /* إلغاء الهوامش التلقائية للمحتوى */
            }
            
            body {
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
                font-size: 7px; /* تصغير الخط أكثر ليتسع المحتوى */
                line-height: 1.1; /* تقليل التباعد بين الأسطر */
                justify-content: flex-start;
                align-items: flex-start;
                overflow-x: hidden; 
            }
            
            .a4-page {
                box-shadow: none !important;
                max-width: 100% !important;
                width: 210mm !important;
                min-height: 297mm !important;
                height: 297mm !important; /* تثبيت الارتفاع */
                transform: scale(1.0) !important; 
                overflow: hidden !important; /* منع أي overflow */
                border: none !important;
                background-color: transparent !important;
                
                /* تطبيق الهوامش الداخلية هنا (لترك مساحة بيضاء حول المحتوى) */
                padding: 1.0cm 1.0cm 1.0cm 1.0cm !important; /* تقليل الهوامش إلى 1 سم */
                display: block; 
                position: relative; 
            }
            
            /* ************************************** */
            /* شرائط الرأس والتذييل الثابتة (Fixed Header/Footer Bands) */
            /* ************************************** */
            
            /* شريط الرأس - ثابت في الأعلى */
            .a4-page::before {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 100%;
                height: 1.0cm; /* ارتفاع ثابت للرأس */
                background-color: var(--dark-color) !important; 
                background-image: linear-gradient(to right, var(--grad-start) 0%, var(--grad-end) 100%) !important;
                background-size: 100% 3px; 
                background-repeat: no-repeat;
                background-position: bottom;
                z-index: 10;
            }
            
            /* شريط التذييل - ثابت في الأسفل */
            .a4-page::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 100%;
                height: 0.8cm; /* ارتفاع ثابت للتذييل */
                background-color: var(--dark-color) !important; 
                background-image: linear-gradient(to right, var(--grad-start) 0%, var(--grad-end) 100%) !important;
                background-size: 100% 3px; 
                background-repeat: no-repeat;
                background-position: top;
                z-index: 10;
            }
            
            /* ************************************** */
            /* تعديلات المحتوى الداخلي */
            /* ************************************** */

            /* ترحيل المحتوى ليتناسب مع الرأس */
            .content-wrapper {
                margin-top: 0.1cm !important; 
                margin-bottom: 0.1cm !important; 
                height: calc(29.7cm - 2.0cm - 1.8cm) !important; /* حساب الارتفاع المتبقي */
                display: flex; 
                flex-direction: column;
                justify-content: flex-start;
                gap: 0.05rem !important; /* تقليل المسافات */
            }
            
            /* تثبيت عناصر الرأس داخل الشريط العلوي */
            .header-info-container {
                position: absolute !important;
                top: 0.1cm !important;
                right: 0.1cm !important;
                z-index: 11;
            }
            .header-input {
                color: white !important; 
                font-size: 7px !important;
                padding: 0 !important;
            }
            
            /* موقع العنوان بعد إضافة الشعار */
            .h1-title {
                color: white !important;
                font-size: 9px !important;
                position: absolute !important;
                top: 0.4cm !important;
                left: 2.0cm !important; 
                margin: 0 !important;
                padding: 0 !important;
                z-index: 11;
            }
            
            /* موقع الشعار في الطباعة */
            .moe-logo {
                position: absolute !important;
                top: 0.3cm !important;
                left: 1.0cm !important; 
                height: 15px !important; 
                width: auto !important;
                z-index: 11;
            }
            
            /* ************************************** */
            /* ضغط عناصر الجدول والتوقيعات */
            /* ************************************** */
            
            .report-table th, .report-table td {
                padding: 0.5px 1px !important; 
                height: 12px !important; /* تقليل ارتفاع الخلايا */
                font-size: 6.5px !important; /* تصغير الخط */
            }
            .fillable-input {
                padding: 0 2px !important;
                font-size: 6.5px !important;
            }
            .h2-title {
                padding: 1px 4px !important; 
                font-size: 7.5px !important;
                margin-top: 0.05rem !important; 
            }
            .signature-label-text {
                font-size: 6.5px !important;
            }
            .signature-input-name {
                 font-size: 7px !important;
                 border-bottom: 1px dashed #000000 !important; 
            }
            .signature-footer {
                position: absolute !important;
                bottom: 0.1cm !important; 
                left: 1.0cm !important;
                right: 1.0cm !important;
                margin: 0 !important;
                padding: 0 !important;
                z-index: 11;
            }
            .w-48 {
                width: 33% !important; /* توزيع التوقيعات بالتساوي */
            }
            
            /* شواهد التفعيل - أقصى ضغط */
            .evidence-box {
                min-height: 40px !important; 
                padding: 0 !important;
                gap: 2px !important;
            }
            .image-slot-aspect {
                padding-top: 60% !important; /* تقليل نسبة العرض/الارتفاع */
            }
            .image-slot-content {
                font-size: 6px !important;
            }
            /* تحديث ألوان الخلايا الثابتة للعرض والطباعة */
            .report-table th {
                background-color: var(--dark-color) !important; 
                color: white !important;
            }
            .fixed-cell {
                background-color: var(--grad-start) !important; 
                color: white !important;
            }
            .h2-title {
                background-color: var(--grad-end) !important;
                color: white !important;
            }
        }

        /*
        *****************************************************************
        تنسيقات الشاشة (Preview) - الخلفية البيضاء مع الشريط العلوي والسفلي
        *****************************************************************
        */
        body {
            font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f0f0f0; 
            padding: 10px; 
            display: flex; 
            flex-direction: column;
            justify-content: flex-start;
            align-items: center; 
            min-height: 100vh; 
            overflow-x: auto; 
        }

        .a4-page {
            width: 210mm; 
            min-height: 297mm; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            margin: 0 auto; 
            position: relative;
            padding: 1.0cm 1.5cm 0.8cm 1.5cm; /* تقليل هوامش المعاينة */
            color: #000000; 
            font-size: 11.5px; 
            display: flex; 
            flex-direction: column; 
            max-width: 100%; 
            background-color: white; 
            overflow: hidden;
        }

        /* محاكاة الشريط العلوي في المعاينة */
        .a4-page::before {
             content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 1.0cm; /* ارتفاع مطابق للطباعة */
            background-color: var(--dark-color); 
            background-image: linear-gradient(to right, var(--grad-start) 0%, var(--grad-end) 100%); 
            background-size: 100% 3px; 
            background-repeat: no-repeat;
            background-position: bottom;
            z-index: 10;
        }
        
        /* محاكاة الشريط السفلي في المعاينة */
        .a4-page::after {
             content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 0.8cm; /* ارتفاع مطابق للطباعة */
            background-color: var(--dark-color); 
            background-image: linear-gradient(to right, var(--grad-start) 0%, var(--grad-end) 100%); 
            background-size: 100% 3px; 
            background-repeat: no-repeat;
            background-position: top;
            z-index: 10;
        }

        /* تثبيت موقع بيانات الرأس داخل الشريط */
        .header-info-container {
            position: absolute;
            top: 0.1cm;
            right: 1.5cm; 
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            space-y: 1px;
            z-index: 20;
        }
        
        .header-input {
            background-color: transparent !important;
            border: none; 
            color: white !important; 
            text-align: right;
            font-weight: 800; 
            font-size: 13px; 
        }
        
        .h1-title {
            color: white !important;
            font-size: 16px; 
            position: absolute;
            top: 0.4cm;
            left: 3.0cm; /* تم تعديل الموقع لإتاحة مساحة للشعار في المعاينة */
            margin: 0;
            padding: 0;
            z-index: 20;
        }
        
        /* موقع الشعار في المعاينة */
        .moe-logo {
            position: absolute;
            top: 0.3cm;
            left: 1.5cm;
            height: 30px; /* حجم مناسب للمعاينة */
            width: auto;
            z-index: 20;
        }
        
        /* *************** باقي تنسيقات المحتوى *************** */

        .content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.3rem; 
            overflow-y: hidden; 
            /* ترك مساحة للرأس والثذييل في المعاينة */
            margin-top: 0.5cm;
            margin-bottom: 0.5cm;
        }

        .fillable-input {
            border: 1px solid #c0c0c0; 
            color: #000000; 
            padding: 0 4px;
            outline: none;
            width: 100%;
            opacity: 1; 
            font-size: 10px; 
        }
        
        .h2-title {
            padding: 2px 8px; 
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 0; 
            margin-top: 0.2rem; 
            font-size: 11px; 
            /* الألوان الجديدة */
            background-color: var(--grad-end);
            color: white; 
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.2rem; 
            color: #000000; 
            font-size: 9px; 
            table-layout: fixed; 
        }

        .report-table th, .report-table td {
            border: 1px solid #666666; 
            padding: 1px; 
            height: 18px; 
            text-align: center;
            background-color: white;
        }

        /* الألوان الجديدة لرؤوس الجداول */
        .report-table th {
            background-color: var(--dark-color); 
            color: white;
        }
        
        /* الألوان الجديدة للخلايا الثابتة */
        .fixed-cell {
            background-color: var(--grad-start); 
            color: white;
            font-weight: bold;
        }

        .signature-label-text {
            color: #000000; 
            font-size: 9px; 
            margin-bottom: 0; 
            font-weight: bold;
        }

        .signature-input-name {
            text-align: center;
            width: 100%;
            color: #000000; 
            font-size: 10px;
            border: none; 
            background-color: transparent;
            outline: none;
            padding-bottom: 0;
            margin-top: 2px; 
            border-bottom: 1px solid #ccc; 
        }
         .signature-input-title {
            display: none; 
        }
        
        .signature-footer {
            width: 100%;
            margin-top: 0.4rem; 
            padding-top: 2px; 
            padding-bottom: 2px; 
            flex-shrink: 0; 
            z-index: 20;
        }

        .evidence-box {
            padding: 1px; 
            text-align: right;
            min-height: 85px; 
            flex-shrink: 0; 
        }

        .image-slot-container {
            width: 24.2%;
            position: relative;
        }
        .image-slot-aspect {
            padding-top: 90%; 
            border: 1px dashed #666; 
            background-color: #f8f8f8; 
            border-radius: 4px; 
        }
        .image-slot-content {
            font-size: 8px; 
        }
    </style>
</head>
<body>

    <!-- Print Button for convenience -->
    <div class="fixed top-4 left-4 z-50 no-print">
        <button onclick="window.print()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-150">
            تحويل إلى PDF / طباعة
        </button>
    </div>

    <!-- الحاوية الرئيسية A4 -->
    <div class="a4-page">
        <!-- شعار وزارة التعليم (شعار وزارة التعليم) -->
        <img id="moeLogo" 
            src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" 
            alt="شعار وزارة التعليم" 
            class="moe-logo" 
            onerror="this.onerror=null; this.src='https://placehold.co/50x50/003a47/ffffff?text=شعار';">
        
        <!-- Report Title - Fixed position in print mode -->
        <h1 class="h1-title text-center font-bold">تفعيل المدرسة للتعلم الالكتروني</h1>

        <!-- Header Info Container - Fixed position in print mode -->
        <div class="header-info-container">
            <!-- اسم الادارة التعليمية -->
            <input type="text" id="adminName" data-key="adminName" class="header-input text-right w-[100mm]" placeholder="الإدارة التعليمية (سجل هنا اسم الإدارة كاملاً)">
            <!-- اسم المدرسة -->
            <input type="text" id="schoolName" data-key="schoolName" class="header-input text-right w-[100mm]" placeholder="المدرسة (سجل هنا اسم المدرسة كاملاً)">
        </div>


        <!-- Content Wrapper to contain all tables and evidence -->
        <div class="content-wrapper">
            <!-- Table 1: Date and Place - (Hidden in Print Mode) -->
            <div class="mb-0 table-date-location"> 
                <h2 class="h2-title">بيانات الزيارة (لإدخال البيانات فقط، لن تظهر في الطباعة)</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>الفصل الدراسي</th>
                            <th>اليوم</th>
                            <th>التاريخ</th>
                            <th>مكان التفعيل</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" data-key="t1_col1" class="fillable-input text-center" placeholder="الفصل"></td>
                            <td><input type="text" data-key="t1_col2" class="fillable-input text-center" placeholder="اليوم"></td>
                            <td><input type="text" data-key="t1_col3" class="fillable-input text-center" placeholder="التاريخ"></td>
                            <td><input type="text" data-key="t1_col4" class="fillable-input text-center" placeholder="المكان"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 2: Personnel (5 rows) -->
            <div class="mb-0"> 
                <h2 class="h2-title">الكادر المفعل للتعليم الإلكتروني</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">م</th>
                            <th>اسم الكادر المفعل للتعليم الالكتروني</th>
                            <th>عمله داخل المدرسة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 5 rows for personnel -->
                        <tr><td>1</td><td><input type="text" data-key="t2_r1c1" class="fillable-input"></td><td><input type="text" data-key="t2_r1c2" class="fillable-input"></td></tr>
                        <tr><td>2</td><td><input type="text" data-key="t2_r2c1" class="fillable-input"></td><td><input type="text" data-key="t2_r2c2" class="fillable-input"></td></tr>
                        <tr><td>3</td><td><input type="text" data-key="t2_r3c1" class="fillable-input"></td><td><input type="text" data-key="t2_r3c2" class="fillable-input"></td></tr>
                        <tr><td>4</td><td><input type="text" data-key="t2_r4c1" class="fillable-input"></td><td><input type="text" data-key="t2_r4c2" class="fillable-input"></td></tr>
                        <tr><td>5</td><td><input type="text" data-key="t2_r5c1" class="fillable-input"></td><td><input type="text" data-key="t2_r5c2" class="fillable-input"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Combined Table 3 & 4: Platforms and Devices -->
            <div class="mb-0"> 
                <h2 class="h2-title">التفعيل والأجهزة الإلكترونية المستخدمة</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th colspan="2" class="w-1/2">نوع التفعيل الالكتروني المستخدم</th>
                            <th colspan="2" class="w-1/2">اسم الجهاز الالكتروني المستخدم</th> 
                        </tr>
                        <tr>
                            <th class="w-1/4">اسم المنصة/النوع</th>
                            <th class="w-1/4">ملاحظات أو تفاصيل</th> 
                            <th class="w-1/4">اسم الجهاز</th>
                            <th class="w-8">اختيار</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1: المنصة / بروجكتر -->
                        <tr>
                            <td class="fixed-cell">اسم المنصة</td>
                            <td><input type="text" data-key="t3_r1c2" class="fillable-input"></td>
                            <td>جهاز عرض (بروجكتر)</td>
                            <td><input type="checkbox" data-key="t4_c1" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                        <!-- Row 2: القناة / كمبيوتر مكتبي -->
                        <tr>
                            <td class="fixed-cell">اسم القناة</td>
                            <td><input type="text" data-key="t3_r2c2" class="fillable-input"></td>
                            <td>جهاز كمبيوتر مكتبي</td>
                            <td><input type="checkbox" data-key="t4_c2" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                        <!-- Row 3: البرنامج / لابتوب -->
                        <tr>
                            <td class="fixed-cell">اسم البرنامج</td>
                            <td><input type="text" data-key="t3_r3c2" class="fillable-input"></td>
                            <td>جهاز لابتوب</td>
                            <td><input type="checkbox" data-key="t4_c3" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                        <!-- Row 4: أخرى: تذكر / ايباد -->
                        <tr>
                            <td class="fixed-cell font-bold" readonly>أخرى: تذكر</td>
                            <td><input type="text" data-key="t3_r4c2" class="fillable-input"></td>
                            <td>جهاز الايباد</td>
                            <td><input type="checkbox" data-key="t4_c4" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                        <!-- Row 5: - / جوال -->
                        <tr>
                            <td colspan="2" class="bg-gray-200 opacity-50">&nbsp;</td>
                            <td>جهاز الجوال</td>
                            <td><input type="checkbox" data-key="t4_c5" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                        <!-- Row 6: - / أخرى: إدخال -->
                        <tr>
                            <td colspan="2" class="bg-gray-200 opacity-50">&nbsp;</td>
                            <td>أخرى: <input type="text" data-key="t4_c6_text" class="fillable-input w-40 text-xs"></td>
                            <td><input type="checkbox" data-key="t4_c6" class="h-3 w-3 bg-white border-gray-300 rounded text-blue-600 focus:ring-blue-500"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 5: Target Audience -->
            <div class="mb-0"> 
                <h2 class="h2-title">الفئة المستهدفة</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                            <th class="w-8">رقم</th>
                            <th>تحديد الفئة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="text" data-key="t5_r1c1" class="fillable-input"></td>
                            <td>2</td>
                            <td><input type="text" data-key="t5_r1c2" class="fillable-input"></td>
                            <td>3</td>
                            <td><input type="text" data-key="t5_r1c3" class="fillable-input"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 6: Objectives and Impact (3 rows) -->
            <div class="mb-0"> 
                <table class="report-table">
                    <thead>
                        <tr>
                            <th class="w-1/2">الهدف من استخدام التفعيل الالكتروني (1 - 3 أهداف)</th>
                            <th class="w-1/2">الأثر الإيجابي التربوي والتعليمي للتفعيل الالكتروني المذكور</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><input type="text" data-key="t6_r1c1" class="fillable-input"></td><td><input type="text" data-key="t6_r1c2" class="fillable-input"></td></tr>
                        <tr><td><input type="text" data-key="t6_r2c1" class="fillable-input"></td><td><input type="text" data-key="t6_r2c2" class="fillable-input"></td></tr>
                        <tr><td><input type="text" data-key="t6_r3c1" class="fillable-input"></td><td><input type="text" data-key="t6_r3c2" class="fillable-input"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Evidence Section (Image Uploads) - Tightly constrained -->
            <div class="mb-0"> 
                <h2 class="h2-title">شواهد التفعيل</h2>
                
                <div class="evidence-box flex justify-between gap-1 p-0.5 items-center">
                    
                    <!-- Image Slot 1 -->
                    <div class="image-slot-container">
                        <div id="imageSlot1" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput1" data-slot="1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview1" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label1" class="absolute inset-0 flex items-center justify-center p-1 text-black z-0">صورة 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Slot 2 -->
                    <div class="image-slot-container">
                        <div id="imageSlot2" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput2" data-slot="2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview2" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label2" class="absolute inset-0 flex items-center justify-center p-1 text-black z-0">صورة 2</span>
                            </div>
                        </div>
                    </div>

                    <!-- Image Slot 3 -->
                    <div class="image-slot-container">
                        <div id="imageSlot3" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput3" data-slot="3" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview3" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label3" class="absolute inset-0 flex items-center justify-center p-1 text-black z-0">صورة 3</span>
                            </div>
                        </div>
                    </div>

                    <!-- Image Slot 4 -->
                    <div class="image-slot-container">
                        <div id="imageSlot4" class="image-slot-aspect relative">
                            <div class="image-slot-content">
                                <input type="file" id="fileInput4" data-slot="4" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="handleImageUpload(this)">
                                <img id="preview4" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                <span id="label4" class="absolute inset-0 flex items-center justify-center p-1 text-black z-0">صورة 4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End of content-wrapper -->
        
        <!-- Signature/Name Boxes - Fixed position in print mode -->
        <div class="signature-footer flex justify-between px-4">
            
            <!-- أمينة مصادر التعلم -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">أمينة مصادر التعلم</p>
                <!-- Name (Bolded) - No border-bottom for cleaner look -->
                <input type="text" data-key="signature_1_name" class="signature-input-name font-bold" placeholder="الاسم">
                <!-- Title (الصفة) - HIDDEN -->
                <input type="text" data-key="signature_1_title" class="signature-input-title" placeholder="التوقيع">
            </div>
            
            <!-- مشرفة الدعم -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">مشرفة الدعم</p>
                <!-- Name (Bolded) - No border-bottom for cleaner look -->
                <input type="text" data-key="signature_2_name" class="signature-input-name font-bold" placeholder="الاسم">
                <!-- Title (الصفة) - HIDDEN -->
                <input type="text" data-key="signature_2_title" class="signature-input-title" placeholder="التوقيع">
            </div>
            
            <!-- مديرة المدرسة -->
            <div class="text-center w-48 flex flex-col items-center">
                <p class="signature-label-text">مديرة المدرسة</p>
                <!-- Name (Bolded) - No border-bottom for cleaner look -->
                <input type="text" data-key="signature_3_name" class="signature-input-name font-bold" placeholder="الاسم">
                <!-- Title (الصفة) - HIDDEN -->
                <input type="text" data-key="signature_3_title" class="signature-input-title" placeholder="التوقيع">
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const IMAGE_SLOTS = 4; // Number of image slots
        const REPORT_DOC_ID = 'content'; // Fixed document ID for the report data

        // --- DOM Elements ---
        const allPersistentInputs = Array.from(document.querySelectorAll('input[data-key]:not([type="file"]):not(.fixed-input), textarea[data-key]')); // Include textarea

        let db, auth;
        let userId;
        
        /**
         * Converts a File object to a Base64 string.
         * WARNING: Files resulting in a Base64 string > 1MB will fail to save to Firestore.
         * @param {File} file 
         * @returns {Promise<string>} Base64 string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Displays a custom alert/modal message to the user.
         * @param {string} message The message to display.
         */
        function showCustomAlert(message) {
            const containerId = 'customAlertContainer';
            let container = document.getElementById(containerId);
            
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                // Basic fixed centering style for the modal container
                container.style.cssText = `
                    position:fixed;
                    top:0;
                    left:0;
                    width:100%;
                    height:100%;
                    background:rgba(0,0,0,0.5);
                    z-index:9999;
                    display:flex;
                    justify-content:center;
                    align-items:center;
                `;
                document.body.appendChild(container);
            }
            
            // Modal content structure
            container.innerHTML = `
                <div style="
                    background:white;
                    padding:20px;
                    border-radius:10px;
                    box-shadow:0 0 15px rgba(0,0,0,0.7);
                    max-width: 90%;
                    text-align: center;
                    font-family: 'Cairo', sans-serif;
                ">
                    <p style="margin-bottom: 15px; color: #333; font-size: 14px;">${message}</p>
                    <button onclick="document.getElementById('${containerId}').remove()" 
                        style="
                            padding:8px 15px;
                            background:#f44336;
                            color:white;
                            border:none;
                            border-radius:5px;
                            cursor:pointer;
                            font-weight: bold;
                        ">إغلاق</button>
                </div>
            `;
            container.style.display = 'flex'; // Ensure it's visible
        }


        /**
         * Handles image file selection, conversion to Base64, and display.
         * @param {HTMLInputElement} input The file input element
         */
        window.handleImageUpload = async function(input) {
            const slotNumber = input.getAttribute('data-slot');
            const file = input.files[0];
            const previewElement = document.getElementById(`preview${slotNumber}`);
            const labelElement = document.getElementById(`label${slotNumber}`);
            const imageKey = `imageSlot${slotNumber}`;
            
            if (file) {
                try {
                    // Check file size limit (1MB = 1048576 bytes) BEFORE converting to base64
                    if (file.size > 1048576 * 0.7) { // Using 700KB as a safe buffer for base64 encoding overhead
                         showCustomAlert("تحذير: قد تكون الصورة كبيرة جداً. يرجى اختيار صورة بحجم أصغر من 700 كيلوبايت لضمان الحفظ.");
                    }


                    const base64String = await fileToBase64(file);
                    
                    // Update DOM
                    previewElement.src = base64String;
                    previewElement.classList.remove('hidden');
                    previewElement.classList.add('z-10'); 
                    labelElement.classList.add('hidden');
                    
                    // Save the Base64 string immediately
                    await saveData({ [imageKey]: base64String }, true); // Force save image data
                    
                } catch (error) {
                    console.error("Error reading file:", error.message); 
                    
                    // Clear the slot appearance and the input
                    previewElement.src = ''; // Clear image source
                    previewElement.classList.add('hidden');
                    previewElement.classList.remove('z-10'); 
                    labelElement.classList.remove('hidden');
                    input.value = ''; 
                    
                    await saveData({ [imageKey]: '' }, true);
                }
            } else {
                 // If file is cleared
                previewElement.classList.add('hidden');
                previewElement.classList.remove('z-10');
                labelElement.classList.remove('hidden');
                await saveData({ [imageKey]: '' }, true); // Clear the slot in persistence
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`User authenticated with ID: ${userId}`);
                
                // Start loading data and listening for changes
                setupPersistence();

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        }

        /**
         * Saves persistent data to Firestore privately.
         * @param {Object} [partialData] Optional partial data to merge (used for immediate image save)
         * @param {boolean} [isImageSave=false] Flag to indicate if this is only an image save (to prevent saving text fields prematurely)
         */
        async function saveData(partialData = {}, isImageSave = false) {
            if (!db || !userId) {
                console.warn("Firestore or User ID not ready for saving.");
                return;
            }

            const data = {};
            
            // Only collect text/checkbox data if it's not exclusively an image save
            if (!isImageSave) {
                allPersistentInputs.forEach(input => {
                    const key = input.getAttribute('data-key');
                    if (input.type === 'checkbox') {
                        data[key] = input.checked;
                    } else { 
                        data[key] = input.value;
                    }
                });
            }

            Object.assign(data, partialData, { updatedAt: new Date().toISOString() });

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/report_data`, REPORT_DOC_ID);
            
            // Exponential backoff retry logic for saving data
            let attempt = 0;
            const maxRetries = 5;

            while (attempt < maxRetries) {
                try {
                    await setDoc(docRef, data, { merge: true });
                    return; // Success
                } catch (error) {
                    attempt++;
                    console.error(`Error saving data (Attempt ${attempt}):`, error);
                    
                    // Specific error handling for 1MB size limit
                    if (error.code === 'invalid-argument' && error.message.includes('longer than 1048487 bytes')) {
                        const failedImageKey = Object.keys(partialData).find(key => key.startsWith('imageSlot'));
                        if (failedImageKey) {
                            const slotNumber = failedImageKey.replace('imageSlot', '');
                            const previewElement = document.getElementById(`preview${slotNumber}`);
                            const labelElement = document.getElementById(`label${slotNumber}`);
                            const fileInputElement = document.getElementById(`fileInput${slotNumber}`);

                            // Clear the image display
                            previewElement.src = '';
                            previewElement.classList.add('hidden');
                            labelElement.classList.remove('hidden');
                            fileInputElement.value = '';

                            showCustomAlert("خطأ في حفظ الصورة: تجاوز حجم الملف الحد الأقصى المسموح به في قاعدة البيانات (1 ميجابايت). الرجاء استخدام صورة أصغر أو ضغطها.");
                        } else {
                            showCustomAlert("حدث خطأ في حفظ البيانات. قد يكون بسبب تجاوز حجم حقل بيانات آخر.");
                        }
                        return; // Do not retry on size error, as it won't resolve.
                    }
                    
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showCustomAlert("فشل حفظ البيانات بعد عدة محاولات. الرجاء التحقق من اتصالك.");
                        throw error; // Re-throw the error after all retries fail
                    }
                }
            }
        }

        /**
         * Loads and subscribes to data changes from Firestore.
         */
        function setupPersistence() {
            if (!db || !userId) return;

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/report_data`, REPORT_DOC_ID);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update all persistent inputs (Header, Table, Signature)
                    allPersistentInputs.forEach(input => {
                        const key = input.getAttribute('data-key');
                        const value = data[key];
                        if (value !== undefined) {
                            if (input.type === 'checkbox') {
                                input.checked = value;
                            } else { 
                                input.value = value;
                            }
                        }
                    });

                    // Update Image Slots
                    for(let i = 1; i <= IMAGE_SLOTS; i++) {
                        const imageKey = `imageSlot${i}`;
                        const base64 = data[imageKey] || '';
                        const previewElement = document.getElementById(`preview${i}`);
                        const labelElement = document.getElementById(`label${i}`);

                        if (base64 && base64.startsWith('data:')) {
                            previewElement.src = base64;
                            previewElement.classList.remove('hidden');
                            previewElement.classList.add('z-10'); 
                            labelElement.classList.add('hidden');
                        } else {
                            previewElement.src = '';
                            previewElement.classList.add('hidden');
                            previewElement.classList.remove('z-10');
                            labelElement.classList.remove('hidden');
                        }
                    }

                } else {
                    console.log("No data found, starting fresh.");
                }
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }

        // --- Event Listeners for Auto-Save (Debounced for performance) ---
        let saveTimeout;
        const DEBOUNCE_DELAY = 1000; // 1 second delay

        function debounceSave() {
            clearTimeout(saveTimeout);
            // Call saveData without partialData and set isImageSave=false to save all non-image fields
            saveTimeout = setTimeout(() => saveData(), DEBOUNCE_DELAY);
        }

        // Attach listeners to all persistent inputs
        allPersistentInputs.forEach(input => {
            input.addEventListener('input', debounceSave);
        });

        // Initialize everything on window load
        initializeFirebase();

    </script>
</body>
</html>
