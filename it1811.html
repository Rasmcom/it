<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hijri@1.1.2/hijri.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #2c5aa0; --primary-dark: #1e3a5f; --header-dark: #16445b;
            --header-light: #0f2a35; --light-bg: #f8f9fa; --border-color: #ddd;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--header-dark) 0%, var(--header-light) 100%); padding: 20px; color: white; display: flex; align-items: center; justify-content: flex-start; gap: 15px; flex-wrap: wrap; }
        .input-section input { padding: 4px 8px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.95); color: #333; height: 28px; width: 260px; }
        .input-section { display: flex; flex-direction: column; gap: 2px; min-width: 280px; }
        .logo { width: 100px; height: auto; }
        .title-section { padding: 30px; text-align: center; background: var(--light-bg); border-bottom: 3px solid var(--primary-color); }
        .main-title { font-size: 28px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .month-input { border: none; background: transparent; font-size: 26px; font-weight: 700; color: var(--primary-color); text-align: center; padding: 8px; border-bottom: 3px solid var(--primary-color); cursor: pointer; width: 300px; max-width: 90%; }
        .controls { padding: 25px 30px; background: var(--light-bg); display: grid; grid-template-columns: 1fr auto auto; gap: 20px; align-items: start; }
        .names-input { grid-column: 1 / 2; }
        .duty-count-section { grid-column: 2 / 3; }
        .btn-group { grid-column: 3 / 4; }
        .names-input label { display: block; margin-bottom: 12px; font-weight: 600; font-size: 16px; color: #333; }
        .names-input textarea { width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 16px; resize: vertical; min-height: 120px; transition: border-color 0.3s ease; }
        .names-input textarea:focus { outline: none; border-color: var(--primary-color); }
        .duty-count-section { display: flex; flex-direction: column; gap: 10px; }
        .duty-count-input { display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        .duty-count-input label { font-weight: 600; white-space: nowrap; }
        .duty-count-input input { width: 60px; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); text-align: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .table-container { padding: 30px; overflow-x: auto; }
        .main-table { width: 100%; border-collapse: collapse; font-size: 14px; background: white; }
        .main-table th, .main-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; vertical-align: middle; }
        .main-table th { font-weight: 700; background: #4a6a8a; color: white; }
        .main-table .sub-header th { background-color: #e9ecef; color: #333; font-size: 12px; }
        .main-table th input.header-input { background: transparent; color: white; border: none; font-size: inherit; font-weight: inherit; text-align: center; width: 100%; }
        .main-table td input, .main-table td select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .duty-entry { display: flex; gap: 5px; align-items: center; }
        .duty-entry:not(:last-child) { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .duty-entry .teacher-select { flex: 3; }
        .duty-entry .status-select { flex: 2; }
        .date-cell { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .hijri-date-display { font-size: 12px; font-weight: 600; color: var(--primary-dark); min-height: 18px; }
        .footer { padding: 30px; background: var(--light-bg); text-align: center; }
        .signature-area { display: flex; justify-content: center; gap: 50px; margin-bottom: 30px; }
        .signature-box label { display: block; font-weight: bold; margin-bottom: 10px; }
        .signature-box input { width: 250px; padding: 8px; border: none; border-bottom: 2px solid var(--border-color); text-align: center; background: transparent; font-weight: bold; }
        .copyright-section { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .copyright-text { font-size: 14px; color: #555; font-weight: 600; }
        .footer-logo { height: 50px; width: auto; }
        #hidden-chart-container { display: none; }
        .loading-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .loading-modal-content { background: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }

        @media (max-width: 992px) {
            body { padding: 10px; }
            .controls { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .table-container { padding: 15px; }
            .main-table th, .main-table td { padding: 6px; font-size: 12px; }
            .main-table td input, .main-table td select { padding: 6px; font-size: 12px; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; }
            .btn-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container" id="record-page">
        <div class="header no-print">
            <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" class="logo" onerror="this.style.display='none'">
            <div class="input-section">
                <input type="text" id="education-dept" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" oninput="saveGlobalData()"><input type="text" id="school-name" placeholder="Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" oninput="saveGlobalData()">
            </div>
        </div>
        <div class="title-section">
            <h1 class="main-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ø´Ù‡Ø± <input type="text" id="hijri-month-input" class="month-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±..." onchange="handleMonthChange(this.value)"></h1>
        </div>
        <div class="controls no-print">
            <div class="names-input">
                <label for="names-textarea">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Øª (Ø§Ø³Ù… ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±):</label>
                <textarea id="names-textarea" placeholder="Ù…Ø«Ø§Ù„:&#10;ÙØ§Ø·Ù…Ø© Ø³Ø¹Ø¯ Ø§Ù„Ø£Ø­Ù…Ø¯&#10;Ù†ÙˆØ±Ø© Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ù„ÙŠ"></textarea>
            </div>
            <div class="duty-count-section">
                <div class="duty-count-input">
                    <label id="duty-label-period1" for="duty-count-period1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨ÙŠÙ†:</label>
                    <input type="number" id="duty-count-period1" value="1" min="1" max="5" onchange="generateTable()">
                </div>
                <div class="duty-count-input">
                    <label id="duty-label-period2" for="duty-count-period2">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨ÙŠÙ†:</label>
                    <input type="number" id="duty-count-period2" value="1" min="1" max="5" onchange="generateTable()">
                </div>
            </div>
            <div class="btn-group">
                 <button class="btn btn-primary" onclick="extractNames()">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
                 <button class="btn btn-danger" onclick="clearNames()">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
                 <button class="btn btn-success" onclick="printSchedule()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                 <button class="btn btn-info" onclick="printStats()">ğŸ“Š Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                 <button class="btn btn-danger" onclick="clearData()">Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
                 <button class="btn btn-warning" onclick="backupData()">ğŸ“¥ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
                 <button class="btn btn-info" onclick="restoreData()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                 <button class="btn btn-danger" onclick="clearAllData()">âš ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                 <input type="file" id="restoreFile" style="display:none;" accept=".txt">
            </div>
        </div>
        <div class="table-container"><table class="main-table" id="main-table"></table></div>
        <div class="footer">
            <div class="signature-area">
                <div class="signature-box">
                    <label>Ù…Ø¯ÙŠØ±/Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                    <input type="text" id="school-principal-signature" placeholder="Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹" oninput="saveData()">
                </div>
            </div>
            <div class="copyright-section no-print">
                <a href="https://t.me/+SJnYvPy7yo5YmI1" target="_blank" rel="noopener noreferrer"><img src="https://e.top4top.io/p_3463x5tj40.png" alt="Ø´Ø¹Ø§Ø± Ù‚Ù†Ø§Ø© Ø±Ø³Ù…" class="footer-logo" onerror="this.style.display='none'"></a>
                <p class="copyright-text">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‚Ù†Ø§Ø© Ø±Ø³Ù… Ù„Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© 2025</p>
            </div>
        </div>
    </div>
    <div id="hidden-chart-container">
        <canvas id="stats-chart-teachers" width="800" height="400"></canvas>
        <canvas id="stats-chart-status" width="400" height="400"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', initializePage);

        function initializePage() {
            Chart.defaults.font.family = "'Cairo', sans-serif";
            loadGlobalData();
            loadCurrentMonth();
            generateTable(); 
        }

        function handleMonthChange(monthName) {
            localStorage.setItem('currentDutyMonth', monthName.trim());
            generateTable();
        }

        function loadCurrentMonth() {
            const monthInput = document.getElementById('hijri-month-input');
            const savedMonth = localStorage.getItem('currentDutyMonth') || 'Ø§Ù„Ù…Ø­Ø±Ù‘Ù…';
            monthInput.value = savedMonth;
        }
        
        function updateDutyCountLabels() {
            const globalData = JSON.parse(localStorage.getItem('globalData')) || {};
            const period1Header = globalData.period1Header || 'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…';
            const period2Header = globalData.period2Header || 'Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…';
            document.getElementById('duty-label-period1').textContent = `Ù…Ù†Ø§ÙˆØ¨Ùˆ (${period1Header}):`;
            document.getElementById('duty-label-period2').textContent = `Ù…Ù†Ø§ÙˆØ¨Ùˆ (${period2Header}):`;
        }

        function getTableHeaders() {
            const globalData = JSON.parse(localStorage.getItem('globalData')) || {};
            const period1 = globalData.period1Header || 'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…';
            const period2 = globalData.period2Header || 'Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…';
            return `<thead>
                <tr>
                    <th colspan="3"><input type="text" id="period1-header-input" class="header-input" value="${period1}" oninput="savePeriodHeader('period1Header', this.value)"></th>
                    <th colspan="3"><input type="text" id="period2-header-input" class="header-input" value="${period2}" oninput="savePeriodHeader('period2Header', this.value)"></th>
                </tr>
                <tr class="sub-header">
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨/Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨/Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
                </tr>
            </thead>`;
        }

        function generateTable() {
            const names = getSavedNames();
            const table = document.getElementById('main-table');
            table.innerHTML = getTableHeaders() + '<tbody id="table-body"></tbody>';
            const teacherOptionsHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>' + (names || []).map(name => `<option value="${name}">${name}</option>`).join('');
            const statusOptionsHTML = '<option value="">-</option><option value="Ù…Ù†ÙØ°">Ù…Ù†ÙØ°</option><option value="ØºÙŠØ± Ù…Ù†ÙØ°">ØºÙŠØ± Ù…Ù†ÙØ°</option>';
            const tableBody = document.getElementById('table-body');
            
            const dutyCount1 = parseInt(document.getElementById('duty-count-period1').value) || 1;
            const dutyCount2 = parseInt(document.getElementById('duty-count-period2').value) || 1;

            for (let i = 0; i < 20; i++) {
                const row = tableBody.insertRow();
                let period1HTML = Array.from({length: dutyCount1}, () => `<div class="duty-entry"><select class="teacher-select" onchange="saveData()">${teacherOptionsHTML}</select><select class="status-select" onchange="saveData()">${statusOptionsHTML}</select></div>`).join('');
                let period2HTML = Array.from({length: dutyCount2}, () => `<div class="duty-entry"><select class="teacher-select" onchange="saveData()">${teacherOptionsHTML}</select><select class="status-select" onchange="saveData()">${statusOptionsHTML}</select></div>`).join('');

                row.innerHTML = `
                    <td><div class="date-cell"><input type="date" onchange="updateDateDisplay(this); saveData();"><span class="hijri-date-display"></span></div></td>
                    <td>${period1HTML}</td>
                    <td><input type="text" oninput="saveData()"></td>
                    <td><div class="date-cell"><input type="date" onchange="updateDateDisplay(this); saveData();"><span class="hijri-date-display"></span></div></td>
                    <td>${period2HTML}</td>
                    <td><input type="text" oninput="saveData()"></td>`;
            }
            updateDutyCountLabels();
            loadData(); 
        }

        function extractNames() {
            const names = document.getElementById('names-textarea').value.split('\n').map(line => line.trim()).filter(line => line).map(abbreviateName);
            saveNames(names);
            document.getElementById('names-textarea').value = '';
            generateTable();
        }

        function getPeriodKey() {
            const monthName = document.getElementById('hijri-month-input').value.trim();
            return monthName ? `duty-roster-${monthName}` : null;
        }

        function saveData() {
            const periodKey = getPeriodKey();
            if (!periodKey) return;
            const tableData = Array.from(document.querySelectorAll('#table-body tr')).map(row => {
                const getPeriodData = (cell) => Array.from(cell.querySelectorAll('.duty-entry')).map(entry => ({ name: entry.querySelector('.teacher-select').value, status: entry.querySelector('.status-select').value }));
                return {
                    p1_date: row.cells[0].querySelector('input[type="date"]').value, p1_duties: getPeriodData(row.cells[1]), p1_sig: row.cells[2].querySelector('input[type="text"]').value,
                    p2_date: row.cells[3].querySelector('input[type="date"]').value, p2_duties: getPeriodData(row.cells[4]), p2_sig: row.cells[5].querySelector('input[type="text"]').value,
                };
            });
            localStorage.setItem(periodKey, JSON.stringify({ tableData, signatures: { schoolPrincipal: document.getElementById('school-principal-signature').value } }));
        }
        
        function loadData() {
            const periodKey = getPeriodKey();
            if (!periodKey) return;
            const savedData = JSON.parse(localStorage.getItem(periodKey));
            if (savedData) {
                document.getElementById('school-principal-signature').value = savedData.signatures?.schoolPrincipal || '';
                const rows = document.querySelectorAll('#table-body tr');
                savedData.tableData?.forEach((rowData, rowIndex) => {
                    const row = rows[rowIndex];
                    if (row) {
                        row.cells[0].querySelector('input[type="date"]').value = rowData.p1_date || '';
                        row.cells[2].querySelector('input[type="text"]').value = rowData.p1_sig || '';
                        row.cells[3].querySelector('input[type="date"]').value = rowData.p2_date || '';
                        row.cells[5].querySelector('input[type="text"]').value = rowData.p2_sig || '';
                        const setPeriodData = (cell, duties) => {
                            const entries = cell.querySelectorAll('.duty-entry');
                            duties?.forEach((duty, i) => { if (entries[i]) { entries[i].querySelector('.teacher-select').value = duty.name; entries[i].querySelector('.status-select').value = duty.status; } });
                        };
                        setPeriodData(row.cells[1], rowData.p1_duties);
                        setPeriodData(row.cells[4], rowData.p2_duties);
                        updateDateDisplay(row.cells[0].querySelector('input[type="date"]'));
                        updateDateDisplay(row.cells[3].querySelector('input[type="date"]'));
                    }
                });
            }
        }

        function calculateStats() {
            const teacherStats = {};
            getSavedNames().forEach(name => { teacherStats[name] = { total: 0, executed: 0, notExecuted: 0 }; });
            const executionStatus = { 'Ù…Ù†ÙØ°': 0, 'ØºÙŠØ± Ù…Ù†ÙØ°': 0 };
            const savedData = JSON.parse(localStorage.getItem(getPeriodKey()));

            savedData?.tableData?.forEach(row => {
                const countDuties = (duties) => {
                    duties?.forEach(duty => {
                        if (duty.name && teacherStats.hasOwnProperty(duty.name)) {
                            teacherStats[duty.name].total++;
                            if (duty.status === 'Ù…Ù†ÙØ°') {
                                teacherStats[duty.name].executed++;
                            } else if (duty.status === 'ØºÙŠØ± Ù…Ù†ÙØ°') {
                                teacherStats[duty.name].notExecuted++;
                            }
                        }
                        if (duty.status && executionStatus.hasOwnProperty(duty.status)) {
                            executionStatus[duty.status]++;
                        }
                    });
                };
                countDuties(row.p1_duties);
                countDuties(row.p2_duties);
            });
            return { teacherStats, executionStatus };
        }
        
        function getPrintStyles(isStats = false) {
            const baseStyle = `@page{size: A4 portrait;margin:1cm;} *{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;} body{direction:rtl;font-family:'Cairo',sans-serif;}`;
            const headerFooterStyle = `.print-header-info{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:20px; border-bottom: 2px solid #000;}.print-header-info div{font-size:14px;font-weight:bold;}.print-header-info img{max-height:60px;}.print-footer{margin-top:40px;text-align:left;font-size:14px;font-weight:bold;}`;
            const statsStyle = `h1,h2{text-align:center;} .stats-container{display: grid; grid-template-columns: 1fr; gap: 40px;} table{width:100%;border-collapse:collapse;margin:20px 0; font-size: 10pt;}th,td{border:1px solid #ccc;padding:8px;text-align:center;}th{background-color:#f2f2f2 !important;}img{display:block;max-width:90%;margin:20px auto;}`;
            const scheduleStyle = `.print-title{text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px;} .print-table{width:100%;border-collapse:collapse;font-size:9.5pt;}.print-table th,.print-table td{border:1px solid #000 !important;padding:6px;text-align:center;vertical-align:middle;word-break:break-word;}.print-table th{background-color:#4a6a8a !important;color:white !important;}.print-table .sub-header th{background-color:#e9ecef !important;color:#333 !important;} .duty-entry-print{padding: 2px 0; text-align:center;} .duty-entry-print:not(:last-child){border-bottom: 1px dotted #ccc;}`;
            return `<style>${baseStyle}${headerFooterStyle}${isStats ? statsStyle : scheduleStyle}</style>`;
        }
        
        function getPrintHeaderHTML() {
            const globalData = JSON.parse(localStorage.getItem('globalData')) || {};
            const logoSrc = document.querySelector('.header .logo')?.src || '';
            return `<div class="print-header-info"><div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ${globalData.dept || '............'}<br>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${globalData.school || '............'}</div><img src="${logoSrc}" alt="logo"></div>`;
        }
        
        function getPrintableTableHeader() {
            const period1Name = document.getElementById('period1-header-input').value;
            const period2Name = document.getElementById('period2-header-input').value;
            return `<thead><tr><th colspan="3">${period1Name}</th><th colspan="3">${period2Name}</th></tr><tr class="sub-header"><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨/Ø©</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨/Ø©</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th></tr></thead>`;
        }

        function printSchedule() {
            const titleHTML = `<div class="print-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ø´Ù‡Ø± ${document.getElementById('hijri-month-input').value}</div>`;
            const tableHeaderHTML = getPrintableTableHeader();
            let tableContentHTML = '';
            document.querySelectorAll('#table-body tr').forEach(row => {
                const date1 = row.cells[0].querySelector('input[type="date"]').value;
                const date2 = row.cells[3].querySelector('input[type="date"]').value;
                if (!date1 && !date2) return;
                const getDutiesHTML = (cell) => Array.from(cell.querySelectorAll('.duty-entry')).map(entry => { const teacher = entry.querySelector('.teacher-select').value; return teacher ? `<div class="duty-entry-print">${teacher}</div>` : '<div class="duty-entry-print">&nbsp;</div>'; }).join('');
                tableContentHTML += `<tr><td>${formatHijriDateShort(date1)}</td><td>${getDutiesHTML(row.cells[1])}</td><td></td><td>${formatHijriDateShort(date2)}</td><td>${getDutiesHTML(row.cells[4])}</td><td></td></tr>`;
            });
            const footerHTML = `<div class="print-footer">Ù…Ø¯ÙŠØ±/Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${document.getElementById('school-principal-signature').value || '.........................'}</div>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">${getPrintStyles()}</head><body>${getPrintHeaderHTML()}${titleHTML}<table class="print-table">${tableHeaderHTML}<tbody>${tableContentHTML}</tbody></table>${footerHTML}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 750);
        }

        function showLoadingModal() {
            const modal = document.createElement('div');
            modal.id = 'loading-modal';
            modal.className = 'loading-modal';
            modal.innerHTML = `<div class="loading-modal-content"><h2>Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</h2><div id="modal-chart-container"></div></div>`;
            document.body.appendChild(modal);
            const modalChartContainer = document.getElementById('modal-chart-container');
            modalChartContainer.appendChild(document.getElementById('stats-chart-teachers'));
            modalChartContainer.appendChild(document.getElementById('stats-chart-status'));
        }

        function hideLoadingModal() {
            const modal = document.getElementById('loading-modal');
            if (modal) {
                const hiddenContainer = document.getElementById('hidden-chart-container');
                hiddenContainer.appendChild(document.getElementById('stats-chart-teachers'));
                hiddenContainer.appendChild(document.getElementById('stats-chart-status'));
                modal.remove();
            }
        }
        
        async function printStats() {
            showLoadingModal();
            await new Promise(resolve => setTimeout(resolve, 100));

            const { teacherStats, executionStatus } = calculateStats();

            const generateChart = (canvasId, config) => {
                return new Promise((resolve) => {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return resolve(null);
                    if (config.type !== 'doughnut' && (!config.data.labels || config.data.labels.length === 0 || config.data.datasets.every(ds => ds.data.every(item => item === 0)))) { return resolve(null); }
                    if (config.type === 'doughnut' && config.data.datasets[0].data.every(item => item === 0)) { return resolve(null); }
                    new Chart(canvas.getContext('2d'), { ...config, options: { ...config.options, animation: { onComplete: (anim) => resolve(anim.chart.canvas.toDataURL('image/png')) } } });
                });
            };

            const fontOptions = { font: { family: "'Cairo', sans-serif", weight: 'bold' }};
            
            const teacherNamesWithDuties = Object.keys(teacherStats).filter(key => teacherStats[key].total > 0);
            const teacherTotals = teacherNamesWithDuties.map(name => teacherStats[name].total);

            const teacherChartConfig = {
                type: 'bar',
                data: { labels: teacherNamesWithDuties, datasets: [{ label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª', data: teacherTotals, backgroundColor: "#36a2eb" }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { ...fontOptions, stepSize: 1 } }, x: { ticks: fontOptions } }}
            };

            const statusChartConfig = {
                type: 'doughnut',
                data: { labels: ['Ù…Ù†ÙØ°', 'ØºÙŠØ± Ù…Ù†ÙØ°'], datasets: [{ data: [executionStatus['Ù…Ù†ÙØ°'], executionStatus['ØºÙŠØ± Ù…Ù†ÙØ°']], backgroundColor: ['#4bc0c0', '#ff6384'] }] },
                options: { responsive: true, plugins: { legend: { labels: fontOptions } }}
            };
            
            const chartTeachersImage = await generateChart('stats-chart-teachers', teacherChartConfig);
            const chartStatusImage = await generateChart('stats-chart-status', statusChartConfig);

            hideLoadingModal();

            let teachersTableHTML = `<h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Øª</h2><table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</th><th>Ù…Ù†ÙØ°</th><th>ØºÙŠØ± Ù…Ù†ÙØ°</th></tr></thead><tbody>`;
            const sortedTeachers = Object.entries(teacherStats).sort(([,a],[,b]) => b.total - a.total);
            
            if(sortedTeachers.filter(([, stats]) => stats.total > 0).length === 0) {
                 teachersTableHTML += '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>';
            } else {
                sortedTeachers.forEach(([name, stats]) => {
                    if (stats.total > 0) {
                        teachersTableHTML += `<tr><td>${name}</td><td>${stats.total}</td><td>${stats.executed}</td><td>${stats.notExecuted}</td></tr>`;
                    }
                });
            }
            teachersTableHTML += '</tbody></table>';

            const titleHTML = `<h1>ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù„Ø´Ù‡Ø± ${document.getElementById('hijri-month-input').value}</h1>`;
            let printContent = `<div class="stats-container">
                                    <div>${teachersTableHTML}${chartTeachersImage ? `<img src="${chartTeachersImage}">` : ''}</div>
                                    <div><h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</h2>${chartStatusImage ? `<img src="${chartStatusImage}">` : '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ†ÙÙŠØ° Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>'}</div>
                                </div>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">${getPrintStyles(true)}</head><body>${getPrintHeaderHTML()}${titleHTML}${printContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
        }
        
        function saveGlobalData() { localStorage.setItem('globalData', JSON.stringify({ dept: document.getElementById('education-dept').value, school: document.getElementById('school-name').value })); }
        function loadGlobalData() { const data = JSON.parse(localStorage.getItem('globalData')); if (data) { document.getElementById('education-dept').value = data.dept || ''; document.getElementById('school-name').value = data.school || ''; } }
        function abbreviateName(fullName) { const words = fullName.trim().split(/\s+/).filter(Boolean); return words.length > 2 ? `${words[0]} ${words[1]} ${words[words.length - 1]}` : fullName; }
        function savePeriodHeader(key, value) { let globalData = JSON.parse(localStorage.getItem('globalData')) || {}; globalData[key] = value; localStorage.setItem('globalData', JSON.stringify(globalData)); updateDutyCountLabels(); }
        function formatHijriDateWithDay(date) { if (!date) return ''; try { return new Intl.DateTimeFormat('ar-SA-u-nu-latn', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', calendar: 'islamic-umalqura', timeZone: 'UTC' }).format(date).replace('ØŒ', ''); } catch (e) { return ''; } }
        
        function formatHijriDateShort(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString + 'T00:00:00Z');
                const formatter = new Intl.DateTimeFormat('ar-SA-u-nu-latn', { day: 'numeric', month: 'numeric', year: 'numeric', calendar: 'islamic-umalqura', timeZone: 'UTC' });
                const parts = formatter.formatToParts(date);
                const day = parts.find(p => p.type === 'day')?.value;
                const month = parts.find(p => p.type === 'month')?.value;
                const year = parts.find(p => p.type === 'year')?.value.split(' ')[0];
                if (day && month && year) {
                    return `${day}/${month}/${year} Ù‡Ù€`;
                }
                return dateString; // Fallback
            } catch (e) { return dateString; }
        }

        function updateDateDisplay(dateInput) { const dateValue = dateInput.value; const displaySpan = dateInput.nextElementSibling; displaySpan.textContent = dateValue ? formatHijriDateWithDay(new Date(dateValue + 'T00:00:00Z')) : ''; }
        function saveNames(names) { localStorage.setItem('teacherNames', JSON.stringify(names)); }
        function getSavedNames() { return JSON.parse(localStorage.getItem('teacherNames')) || []; }
        function clearNames() { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ø³ÙŠØ¤Ø«Ø± Ù‡Ø°Ø§ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.')) { localStorage.removeItem('teacherNames'); generateTable(); } }
        function clearData() { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·ØŸ')) { const key = getPeriodKey(); if(key) localStorage.removeItem(key); generateTable(); } }
        function clearAllData() { if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ø£Ø³Ù…Ø§Ø¡ØŒ Ø¬Ø¯Ø§ÙˆÙ„ØŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) { localStorage.clear(); location.reload(); } }
        function backupData() { const dataToBackup = {}; Object.keys(localStorage).forEach(key => dataToBackup[key] = localStorage.getItem(key)); const dataStr = JSON.stringify(dataToBackup, null, 2); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([dataStr], { type: 'application/json' })); a.download = `Ø¬Ø¯ÙˆÙ„_Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©_Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${new Date().toISOString().slice(0, 10)}.txt`; a.click(); a.remove(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.'); }
        function restoreData() { const fileInput = document.getElementById('restoreFile'); fileInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; if (confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) { const reader = new FileReader(); reader.onload = (event) => { try { const restoredData = JSON.parse(event.target.result); localStorage.clear(); Object.keys(restoredData).forEach(key => localStorage.setItem(key, restoredData[key])); alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.'); location.reload(); } catch (error) { alert('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­.'); } }; reader.readAsText(file); } }; fileInput.click(); }
    </script>
</body>
</html>
